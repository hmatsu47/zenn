---
title: "Flutter ã§ Supabase ã® PGroonga å…¨æ–‡æ¤œç´¢ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["flutter", "supabase", "å…¨æ–‡æ¤œç´¢", "pgroonga"]
published: true
---

Supabase ãŒ PGroonga ã«å¯¾å¿œã—ãŸã¨èã„ãŸã®ã§ã€Flutter ã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

https://supabase.com/blog/launch-week-6-community-day#postgres-ecosystem

## PGroonga ã¨ã¯

PostgreSQL ã§å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ Groonga ã‚’ä½¿ã†ãŸã‚ã®æ‹¡å¼µæ©Ÿèƒ½ï¼ˆExtensionsï¼‰ã§ã™ã€‚

https://www.clear-code.com/blog/2023/1/17/supabase-support-pgroonga.html

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://pgroonga.github.io/ja/tutorial/

ä»Šå›ã¯ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã—ã¦ Supabase ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ãŠã‚ˆã³ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ä»Šå›ã®é¡Œæã¨ãªã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

éå»ã«ã“ã¡ã‚‰ã®è¨˜äº‹ã§è¨€åŠã—ãŸåœ°å›³ã‚¢ãƒ—ãƒªã§ã™ã€‚

https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1

ç¾åœ¨ä½ç½®ã‹ã‚‰æŒ‡å®šè·é›¢ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‚¹ãƒãƒƒãƒˆã‚’æ¤œç´¢ã—ã¦è·é›¢ãŒè¿‘ã„é †ã«è¿”ã™ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã«ã€å¼•æ•°ã¨`WHERE`å¥ã®æ¡ä»¶ï¼ˆ`CASE WHEN`ã«ã‚ˆã‚‹ï¼‰ã‚’è¿½åŠ ã—ã€æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã‚¹ãƒãƒƒãƒˆã‚’ï¼ˆPGroonga ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å…¨æ–‡æ¤œç´¢ã—ã¦ï¼‰è·é›¢ãŒè¿‘ã„é †ã«è¿”ã™ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«æ”¹ä¿®ã—ã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/hmatsu47/maptool

:::message
å¤‰æ›´å‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©ï¼ˆé–¢é€£éƒ¨åˆ†ï¼‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚

```sql:å¤‰æ›´å‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®šç¾©ï¼ˆé–¢é€£éƒ¨åˆ†ï¼‰
 CREATE TABLE category (
  id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  categoryname text NOT NULL
);

CREATE TABLE spot_opendata (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category_id int REFERENCES category (id) NOT NULL,
  title text NOT NULL,
  describe text NOT NULL,
  location geometry(point, 4326) NOT NULL,
  prefecture text NOT NULL,
  municipality text NOT NULL,
  pref_muni text GENERATED ALWAYS AS (prefecture || municipality) STORED,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
CREATE INDEX spot_location_idx ON spot_opendata USING GIST (location);
CREATE INDEX spot_pref_idx ON spot_opendata (prefecture);
CREATE INDEX spot_muni_idx ON spot_opendata (municipality);
CREATE INDEX spot_pref_muni_idx ON spot_opendata (pref_muni);
```

ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŠ•å…¥ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯[å‰å›è¨˜äº‹](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B)ã¨åŒã˜ã§ã™ã€‚

> - **[ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿](https://github.com/hmatsu47/maptool/tree/main/sampleData/supabase)**
>   - ã“ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ã€ä»¥ä¸‹ã®è‘—ä½œç‰©ã‚’æ”¹å¤‰ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
>     - æ„›çŸ¥çœŒæ–‡åŒ–è²¡ãƒãƒƒãƒ—ï¼ˆãƒŠãƒ“æ„›çŸ¥ï¼‰ã€æ„›çŸ¥çœŒã€ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»ã‚³ãƒ¢ãƒ³ã‚ºãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ è¡¨ç¤ºï¼’.ï¼‘æ—¥æœ¬
>     - https://www.pref.aichi.jp/soshiki/joho/0000069385.html

:::

## PGroonga ã‚’æœ‰åŠ¹ã«ã™ã‚‹

**ã€ŒDatabaseã€-ã€ŒExtensionsã€** ã® **ã€ŒAvailable extensionsã€** ã‹ã‚‰ **ã€ŒPGROONGAã€** ã‚’æ¢ã—ã¦æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_01.png)

æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ **ã€ŒPGROONGAã€** ãŒ **ã€ŒEnabled extensionsã€** ã«ç§»å‹•ã—ã¾ã™ã€‚

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_02.png)

:::message
Extensions ä¸€è¦§ã«ã€ŒPGROONGAã€ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ã€**ã€ŒSettingã€-ã€ŒGeneralã€-ã€ŒInfrastructureã€** ã® **ã€ŒPause projectã€** ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€æ™‚åœæ­¢ã—ã€ãã®å¾Œå†ã³èµ·å‹•ã—ã¾ã™ã€‚
:::

## å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«ã«å…¨æ–‡æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã™ã‚‹

**ã€ŒSQL Editorã€** ã§ **ã€ŒNew queryã€** ã‹ã‚‰ SQL æ–‡ã‚’å®Ÿè¡Œï¼ˆRUNï¼‰ã—ã¾ã™ã€‚

```sql:å…¨æ–‡æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
ALTER TABLE spot_opendata ADD COLUMN ft_text text GENERATED ALWAYS AS (title || ',' || describe || ',' || prefecture || municipality) STORED;
CREATE INDEX pgroonga_content_index
          ON spot_opendata
       USING pgroonga (ft_text)
        WITH (tokenizer='TokenMecab');
```

æœ€åˆã«`ALTER TABLE`ã§å…¨æ–‡æ¤œç´¢å¯¾è±¡ã®ç”Ÿæˆåˆ—ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚

ãã—ã¦ãã®ç”Ÿæˆåˆ—ã«å¯¾ã—ã¦`CREATE INDEX`ã§ PGroonga ã®å…¨æ–‡æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ï¼ˆãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ã«ã¯ MeCab ã‚’æŒ‡å®šï¼‰ã€‚

## ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨æ–‡æ¤œç´¢å¯¾å¿œã«ã™ã‚‹

åŒæ§˜ã«ã€**ã€ŒSQL Editorã€** ã§ **ã€ŒNew queryã€** ã‹ã‚‰ SQL æ–‡ã‚’å®Ÿè¡Œï¼ˆRUNï¼‰ã—ã¾ã™ã€‚

:::message
PostGIS ã®é–¢æ•°ã‚’ä½¿ã†ã‚±ãƒ¼ã‚¹ã¨åŒæ§˜ã€ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ã§æ‰±ã†ã“ã¨ãŒã§ããªã„ã®ã§ï¼ˆå¤šåˆ†ï¼‰ã€ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜è¿°ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ RPC çµŒç”±ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚
:::

```sql:ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³å…¨æ–‡æ¤œç´¢å¯¾å¿œåŒ–
CREATE OR REPLACE
 FUNCTION get_spots(point_latitude double precision, point_longitude double precision, dist_limit int, category_id_number int, keywords text)
RETURNS TABLE (
  distance double precision,
  category_name text,
  title text,
  describe text,
  latitude double precision,
  longitude double precision,
  prefecture text,
  municipality text
) AS $$
BEGIN
  RETURN QUERY
  SELECT ((ST_POINT(point_longitude, point_latitude)::geography <-> spot_opendata.location::geography) / 1000) AS distance,
    category.category_name,
    spot_opendata.title,
    spot_opendata.describe,
    ST_Y(spot_opendata.location),
    ST_X(spot_opendata.location),
    spot_opendata.prefecture,
    spot_opendata.municipality
  FROM spot_opendata
  INNER JOIN category ON spot_opendata.category_id = category.id
  WHERE
    (CASE WHEN dist_limit = -1 AND keywords = '' THEN false ELSE true END)
  AND
    (CASE WHEN dist_limit = -1 THEN true
      ELSE (ST_POINT(point_longitude, point_latitude)::geography <-> spot_opendata.location::geography) <= dist_limit END)
  AND
    (CASE WHEN category_id_number = -1 THEN true
      ELSE category.id = category_id_number END)
  AND
    (CASE WHEN keywords = '' THEN true
      ELSE ft_text &@~ keywords END)
  ORDER BY distance;
END;
$$ LANGUAGE plpgsql;
```

ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³`get_spots`ã®å¼•æ•°ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆ`keywords`ï¼‰ã‚’è¿½åŠ ã—ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºæ–‡å­—ã§ãªã„å ´åˆã« **`WHERE ft_text &@~ keywords`** ã®æ¡ä»¶ã§å…¨æ–‡æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

ã‚ã‚ã›ã¦ã€æ¤œç´¢å¯¾è±¡ã¨ã™ã‚‹è·é›¢ã®ç¯„å›²ï¼ˆ`dist_limit`ï¼‰ã«`-1`ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ç¾åœ¨ä½ç½®ã‹ã‚‰ã®è·é›¢ã‚’é™å®šã›ãšæ¤œç´¢ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚

:::message
[å‰å›è¨˜äº‹](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1)ã®å¾Œã€æ¤œç´¢å¯¾è±¡ã®ã‚¹ãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ†ã‚´ãƒªï¼ˆ`category_id_number`ï¼‰åˆ¥ã«çµã‚Šè¾¼ã‚“ã§ãƒ”ãƒ³è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«æ”¹ä¿®ã—ã¦ã„ã¾ã—ãŸã€‚
:::

ã“ã¡ã‚‰ã¯ SQL Editor ã§`get_spots`ã‚’ä½¿ã£ãŸæ¤œç´¢ä¾‹ã§ã™ã€‚

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_03.png)

:::message alert
ä»¥å‰ã®ã‚¹ãƒˆã‚¢ãƒ‰ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€å¼•æ•°ã®æ•°ãŒé•ã†ã®ã§åˆ¥ç‰©ã¨è¦‹ãªã•ã‚Œã¦`REPLACE`ã•ã‚Œãšã«ãã®ã¾ã¾æ®‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚
**ã€ŒDatabaseã€-ã€ŒFunctionsã€** ã® **ã€Œschema publicã€** ä¸€è¦§ã‹ã‚‰ **ã€ŒDelete functionã€** ã™ã‚‹ã‹ã€SQL Editor ã§`DROP FUNCTION`ã—ã¦ãã ã•ã„ã€‚
:::

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å…¨æ–‡æ¤œç´¢ã‚’çµ„ã¿è¾¼ã‚€

[å‰å›è¨˜äº‹](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1)ã§ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œä¿®æ­£ã—ï¼ˆç½®ãæ›ãˆï¼‰ã¾ã™ã€‚

```yaml:pubspec.yamlï¼ˆé–¢é€£éƒ¨åˆ†ï¼‰
  mapbox_gl: ^0.16.0
  supabase: ^1.5.1
```

```dart:class_definition.dartï¼ˆé–¢é€£éƒ¨åˆ†ï¼‰
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

// éƒ½é“åºœçœŒï¼‹å¸‚åŒºç”ºæ‘
class PrefMuni {
  String prefecture;
  String municipalities;

  PrefMuni(this.prefecture, this.municipalities);

  String getPrefMuni() {
    return prefecture + municipalities;
  }
}

// Supabase category ã®å†…å®¹
class SpotCategory {
  int id;
  String name;

  SpotCategory(this.id, this.name);
}

// Supabase get_spots ã®å†…å®¹
class SpotData {
  num distance;
  String categoryName;
  String title;
  String describe;
  LatLng latLng;
  PrefMuni prefMuni;

  SpotData(this.distance, this.categoryName, this.title, this.describe,
      this.latLng, this.prefMuni);
}

// è¿‘éš£ã‚¹ãƒãƒƒãƒˆä¸€è¦§è¡¨ç¤ºç”»é¢ã«æ¸¡ã™å†…å®¹ä¸€å¼
class NearSpotList {
  List<SpotData> spotList;

  NearSpotList(this.spotList);
}
```

```dart:supabase_access.dart
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

import 'class_definition.dart';

// Supabase Client
SupabaseClient getSupabaseClient(String supabaseUrl, String supabaseKey) {
  return SupabaseClient(supabaseUrl, supabaseKey);
}

Future<List<SpotCategory>> searchSpotCategory(SupabaseClient client) async {
  final List<dynamic> items =
      await client.from('category').select().order('id', ascending: true);
  final List<SpotCategory> resultList = [];
  for (dynamic item in items) {
    final SpotCategory category =
        SpotCategory(item['id'] as int, item['category_name'] as String);
    resultList.add(category);
  }
  return resultList;
}

Future<List<SpotData>> searchNearSpot(SupabaseClient client, LatLng latLng,
    int? distLimit, int? categoryId, String? keywords) async {
  final List<dynamic> items =
      await client.rpc('get_spots', params: {
    'point_latitude': latLng.latitude,
    'point_longitude': latLng.longitude,
    'dist_limit': (distLimit ?? -1),
    'category_id_number': (categoryId ?? -1),
    'keywords': (keywords ?? '')
  });
  final List<SpotData> resultList = [];
  for (dynamic item in items) {
    final SpotData spotData = SpotData(
        item['distance'] as num,
        item['category_name'] as String,
        item['title'] as String,
        item['describe'] as String,
        LatLng((item['latitude'] as num).toDouble(),
            (item['longitude'] as num).toDouble()),
        PrefMuni(item['prefecture'] as String, item['municipality'] as String));
    resultList.add(spotData);
  }
  return resultList;
}
```

---

å‘¼ã³å‡ºã—å´ã®ã†ã¡å…¨æ–‡æ¤œç´¢ã‚’ä½¿ã†ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚èµ·ç‚¹ã‹ã‚‰ã®è·é›¢ãŒè¿‘ã„é †ã«çµæœãŒè¿”ã£ã¦ãã¾ã™ã€‚

```dart:supabase_access.dartå‘¼ã³å‡ºã—å´
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

import 'class_definition.dart';
import 'supabase_access.dart';

  SupabaseClient? _supabaseClient;
  String _supabaseUrl = 'ã€Supabase ã® URLã€‘';
  String _supabaseKey = 'ã€Supabase ã® API Keyã€‘';
  _supabaseClient = getSupabaseClient(_supabaseUrl, _supabaseKey);

  final LatLng position = ã€èµ·ç‚¹ã¨ã™ã‚‹ç·¯åº¦çµŒåº¦ã€‘;
  final List<SpotData> spotList =
      await searchNearSpot(_client!, _latLng!, null, null, keywords);
```

:::message
ã‚«ãƒ†ã‚´ãƒªï¼ˆ`category_id_number`ï¼‰ã§å¯¾è±¡ã‚’çµã‚Šè¾¼ã‚€å ´åˆã¯`searchNearSpot`ã® 3 ã¤ç›®ã®å¼•æ•°ã§ã€èµ·ç‚¹ã‹ã‚‰ã®è·é›¢ï¼ˆmï¼‰ã§å¯¾è±¡ã‚’çµã‚Šè¾¼ã‚€å ´åˆã¯ 4 ã¤ç›®ã®å¼•æ•°ã§æŒ‡å®šã—ã¾ã™ã€‚
:::

:::message alert
[å‰å›è¨˜äº‹](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1#flutter-%E3%81%8B%E3%82%89%E3%82%B9%E3%83%88%E3%82%A2%E3%83%89%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99)åŒæ§˜ã€ã“ã®åˆ©ç”¨ä¾‹ã§ã¯ãƒ¦ãƒ¼ã‚¶ã®è­˜åˆ¥ã‚’ã—ã¦ã„ãªã„ã®ã§ Supabase ã® API Key ã‚’å˜ç´”ã«ãã®ã¾ã¾ä½¿ã£ã¦ã„ã¾ã™ãŒã€RLS ã§ãƒ¦ãƒ¼ã‚¶åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å ´åˆã€é©åˆ‡ãªèªè¨¼æƒ…å ±ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
:::

---

ä»¥ä¸Šã§ã™ã€‚

æœ€åˆæ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã€ŒPGROONGAã€ãŒãªã‹ãªã‹è¡¨ç¤ºã•ã‚Œãšç„¦ã£ãŸä»¥å¤–ã¯ã™ã‚“ãªã‚Šå®Ÿè£…ã§ãã¾ã—ãŸã€‚

---

**2023/1/28 è¿½è¨˜ï¼š**
ç¶šãã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

https://zenn.dev/hmatsu47/articles/supabase_pgroonga_synonyms
