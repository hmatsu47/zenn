---
title: "Flutter で Supabase の PGroonga 全文検索を試してみた"
emoji: "🔍"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["flutter", "supabase", "全文検索", "pgroonga"]
published: true
---

Supabase が PGroonga に対応したと聞いたので、Flutter で試してみました。

https://supabase.com/blog/launch-week-6-community-day#postgres-ecosystem

## PGroonga とは

PostgreSQL で全文検索エンジン Groonga を使うための拡張機能（Extensions）です。

https://www.clear-code.com/blog/2023/1/17/supabase-support-pgroonga.html

チュートリアルのページはこちらです。

https://pgroonga.github.io/ja/tutorial/

今回はこのページを参考にして Supabase のテーブル（インデックス）およびストアドファンクションを実装します。

## 今回の題材となるアプリケーション

過去にこちらの記事で言及した地図アプリです。

https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1

現在位置から指定距離の範囲内にあるスポットを検索して距離が近い順に返すストアドファンクションに、引数と`WHERE`句の条件（`CASE WHEN`による）を追加し、検索キーワードを含むスポットを（PGroonga のインデックスで全文検索して）距離が近い順に返すことができるように改修します。

アプリケーションの GitHub リポジトリはこちらです。

https://github.com/hmatsu47/maptool

:::message
変更前のテーブル・インデックス定義（関連部分）はこちらです。

```sql:変更前のテーブル・インデックス定義（関連部分）
 CREATE TABLE category (
  id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  categoryname text NOT NULL
);

CREATE TABLE spot_opendata (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  category_id int REFERENCES category (id) NOT NULL,
  title text NOT NULL,
  describe text NOT NULL,
  location geometry(point, 4326) NOT NULL,
  prefecture text NOT NULL,
  municipality text NOT NULL,
  pref_muni text GENERATED ALWAYS AS (prefecture || municipality) STORED,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
CREATE INDEX spot_location_idx ON spot_opendata USING GIST (location);
CREATE INDEX spot_pref_idx ON spot_opendata (prefecture);
CREATE INDEX spot_muni_idx ON spot_opendata (municipality);
CREATE INDEX spot_pref_muni_idx ON spot_opendata (pref_muni);
```

テーブルに投入するデータは[前回記事](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B)と同じです。

> - **[サンプルデータ](https://github.com/hmatsu47/maptool/tree/main/sampleData/supabase)**
>   - このサンプルデータは、以下の著作物を改変して利用しています。
>     - 愛知県文化財マップ（ナビ愛知）、愛知県、クリエイティブ・コモンズ・ライセンス 表示２.１日本
>     - https://www.pref.aichi.jp/soshiki/joho/0000069385.html

:::

## PGroonga を有効にする

**「Database」-「Extensions」** の **「Available extensions」** から **「PGROONGA」** を探して有効化します。

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_01.png)

有効化すると **「PGROONGA」** が **「Enabled extensions」** に移動します。

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_02.png)

:::message
Extensions 一覧に「PGROONGA」が表示されない場合は、**「Setting」-「General」-「Infrastructure」** の **「Pause project」** でプロジェクトを一時停止し、その後再び起動します。
:::

## 対象テーブルに全文検索用インデックスを追加する

**「SQL Editor」** で **「New query」** から SQL 文を実行（RUN）します。

```sql:全文検索用インデックス追加
ALTER TABLE spot_opendata ADD COLUMN ft_text text GENERATED ALWAYS AS (title || ',' || describe || ',' || prefecture || municipality) STORED;
CREATE INDEX pgroonga_content_index
          ON spot_opendata
       USING pgroonga (ft_text)
        WITH (tokenizer='TokenMecab');
```

最初に`ALTER TABLE`で全文検索対象の生成列を追加しています。

そしてその生成列に対して`CREATE INDEX`で PGroonga の全文検索インデックスを作成しています（トークナイザには MeCab を指定）。

## ストアドファンクションを全文検索対応にする

同様に、**「SQL Editor」** で **「New query」** から SQL 文を実行（RUN）します。

:::message
PostGIS の関数を使うケースと同様、クエリビルダで扱うことができないので（多分）、ストアドファンクションに記述してアプリケーションから RPC 経由で呼び出します。
:::

```sql:ストアドファンクション全文検索対応化
CREATE OR REPLACE
 FUNCTION get_spots(point_latitude double precision, point_longitude double precision, dist_limit int, category_id_number int, keywords text)
RETURNS TABLE (
  distance double precision,
  category_name text,
  title text,
  describe text,
  latitude double precision,
  longitude double precision,
  prefecture text,
  municipality text
) AS $$
BEGIN
  RETURN QUERY
  SELECT ((ST_POINT(point_longitude, point_latitude)::geography <-> spot_opendata.location::geography) / 1000) AS distance,
    category.category_name,
    spot_opendata.title,
    spot_opendata.describe,
    ST_Y(spot_opendata.location),
    ST_X(spot_opendata.location),
    spot_opendata.prefecture,
    spot_opendata.municipality
  FROM spot_opendata
  INNER JOIN category ON spot_opendata.category_id = category.id
  WHERE
    (CASE WHEN dist_limit = -1 AND keywords = '' THEN false ELSE true END)
  AND
    (CASE WHEN dist_limit = -1 THEN true
      ELSE (ST_POINT(point_longitude, point_latitude)::geography <-> spot_opendata.location::geography) <= dist_limit END)
  AND
    (CASE WHEN category_id_number = -1 THEN true
      ELSE category.id = category_id_number END)
  AND
    (CASE WHEN keywords = '' THEN true
      ELSE ft_text &@~ keywords END)
  ORDER BY distance;
END;
$$ LANGUAGE plpgsql;
```

ストアドファンクション`get_spots`の引数にキーワード（`keywords`）を追加し、キーワードが空文字でない場合に **`WHERE ft_text &@~ keywords`** の条件で全文検索できるようにしました。

あわせて、検索対象とする距離の範囲（`dist_limit`）に`-1`が指定されている場合は、現在位置からの距離を限定せず検索するように変更しています。

:::message
[前回記事](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1)の後、検索対象のスポットデータをカテゴリ（`category_id_number`）別に絞り込んでピン表示できるように改修していました。
:::

こちらは SQL Editor で`get_spots`を使った検索例です。

![](/images/supabase_pgroonga_flutter/supabase_pgroonga_03.png)

:::message alert
以前のストアドファンクションは、引数の数が違うので別物と見なされて`REPLACE`されずにそのまま残ってしまいます。
**「Database」-「Functions」** の **「schema public」** 一覧から **「Delete function」** するか、SQL Editor で`DROP FUNCTION`してください。
:::

## アプリケーションに全文検索を組み込む

[前回記事](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1)で使ったコードをそれぞれ修正し（置き換え）ます。

```yaml:pubspec.yaml（関連部分）
  mapbox_gl: ^0.16.0
  supabase: ^1.5.1
```

```dart:class_definition.dart（関連部分）
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

// 都道府県＋市区町村
class PrefMuni {
  String prefecture;
  String municipalities;

  PrefMuni(this.prefecture, this.municipalities);

  String getPrefMuni() {
    return prefecture + municipalities;
  }
}

// Supabase category の内容
class SpotCategory {
  int id;
  String name;

  SpotCategory(this.id, this.name);
}

// Supabase get_spots の内容
class SpotData {
  num distance;
  String categoryName;
  String title;
  String describe;
  LatLng latLng;
  PrefMuni prefMuni;

  SpotData(this.distance, this.categoryName, this.title, this.describe,
      this.latLng, this.prefMuni);
}

// 近隣スポット一覧表示画面に渡す内容一式
class NearSpotList {
  List<SpotData> spotList;

  NearSpotList(this.spotList);
}
```

```dart:supabase_access.dart
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

import 'class_definition.dart';

// Supabase Client
SupabaseClient getSupabaseClient(String supabaseUrl, String supabaseKey) {
  return SupabaseClient(supabaseUrl, supabaseKey);
}

Future<List<SpotCategory>> searchSpotCategory(SupabaseClient client) async {
  final List<dynamic> items =
      await client.from('category').select().order('id', ascending: true);
  final List<SpotCategory> resultList = [];
  for (dynamic item in items) {
    final SpotCategory category =
        SpotCategory(item['id'] as int, item['category_name'] as String);
    resultList.add(category);
  }
  return resultList;
}

Future<List<SpotData>> searchNearSpot(SupabaseClient client, LatLng latLng,
    int? distLimit, int? categoryId, String? keywords) async {
  final List<dynamic> items =
      await client.rpc('get_spots', params: {
    'point_latitude': latLng.latitude,
    'point_longitude': latLng.longitude,
    'dist_limit': (distLimit ?? -1),
    'category_id_number': (categoryId ?? -1),
    'keywords': (keywords ?? '')
  });
  final List<SpotData> resultList = [];
  for (dynamic item in items) {
    final SpotData spotData = SpotData(
        item['distance'] as num,
        item['category_name'] as String,
        item['title'] as String,
        item['describe'] as String,
        LatLng((item['latitude'] as num).toDouble(),
            (item['longitude'] as num).toDouble()),
        PrefMuni(item['prefecture'] as String, item['municipality'] as String));
    resultList.add(spotData);
  }
  return resultList;
}
```

---

呼び出し側のうち全文検索を使うコードはこちらです。起点からの距離が近い順に結果が返ってきます。

```dart:supabase_access.dart呼び出し側
import 'package:mapbox_gl/mapbox_gl.dart';
import 'package:supabase/supabase.dart';

import 'class_definition.dart';
import 'supabase_access.dart';

  SupabaseClient? _supabaseClient;
  String _supabaseUrl = '【Supabase の URL】';
  String _supabaseKey = '【Supabase の API Key】';
  _supabaseClient = getSupabaseClient(_supabaseUrl, _supabaseKey);

  final LatLng position = 【起点とする緯度経度】;
  final List<SpotData> spotList =
      await searchNearSpot(_client!, _latLng!, null, null, keywords);
```

:::message
カテゴリ（`category_id_number`）で対象を絞り込む場合は`searchNearSpot`の 3 つ目の引数で、起点からの距離（m）で対象を絞り込む場合は 4 つ目の引数で指定します。
:::

:::message alert
[前回記事](https://qiita.com/hmatsu47/items/c3f9cafb499aedaca1f1#flutter-%E3%81%8B%E3%82%89%E3%82%B9%E3%83%88%E3%82%A2%E3%83%89%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99)同様、この利用例ではユーザの識別をしていないので Supabase の API Key を単純にそのまま使っていますが、RLS でユーザ別にデータを保存する場合、適切な認証情報を使ってください。
:::

---

以上です。

最初既存プロジェクトに「PGROONGA」がなかなか表示されず焦った以外はすんなり実装できました。

---

**2023/1/28 追記：**
続きの記事を書きました。

https://zenn.dev/hmatsu47/articles/supabase_pgroonga_synonyms
