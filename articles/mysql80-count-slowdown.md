---
title: "MySQL 8.0 ã§ SELECT COUNT(*) ãŒå¤±é€Ÿã™ã‚‹"
emoji: "ğŸ˜«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["mysql", "aws", "aurora", "rds"]
published: true
---

MySQL 8.0 ã§ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä»¶ã«å¯¾ã™ã‚‹`SELECT COUNT(*)`ãŒãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã«ã‚ˆã£ã¦é«˜é€ŸåŒ–ã•ã‚Œã¾ã—ãŸãŒã€MySQL 5.7 ä»¥å‰ã‚ˆã‚Šã‚‚é…ããªã‚‹ã‚±ãƒ¼ã‚¹ãŒç™ºç”Ÿã—ãŸã®ã§ã€å°‘ã—èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

:::message
ã“ã‚Œã¯ã€Aurora MySQL v1 â†’ v3 ã®ç§»è¡Œæº–å‚™ä¸­ã€å¤§ãã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ•´åˆæ€§ç¢ºèªã«`SELECT * ... LIMIT n`ã¨`SELECT COUNT(*)`ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹éš›ã«å¶ç„¶è¦‹ã¤ã‘ãŸå•é¡Œã§ã™ã€‚
å½“åˆã¯ Aurora MySQL v3ï¼ˆ3.02.0 : MySQL 8.0.23 ãƒ™ãƒ¼ã‚¹ï¼‰ã§èª¿æŸ»ã—ã¦ã„ã¾ã—ãŸãŒã€MySQL 8.0.23 ã€œ 8.0.29 ã§ã‚‚åŒæ§˜ã®çŠ¶æ³ã«ãªã‚Šãã†ãªã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€ã‚ã‚‰ãŸã‚ã¦ RDS for MySQL 8.0.28 ã§ãƒ†ã‚¹ãƒˆã—ç›´ã—ãŸã‚‚ã®ã§ã™ã€‚
:::

### ã‚¿ã‚¤ãƒˆãƒ«ã®å…ƒãƒã‚¿

https://atsuizo.hatenadiary.jp/entry/2019/01/23/112608

## ãƒ†ã‚¹ãƒˆã®å†…å®¹

- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†èµ·å‹•ã—ã¦ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ãŸçŠ¶æ…‹ã‹ã‚‰ã€3 ã¤ã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ä»¶`SELECT COUNT(*)`ã‚’ç¶šã‘ã¦å®Ÿè¡Œã—ã€å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
  - â‘ ã€œâ‘£ ã§ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºï¼ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚º
  - â‘¤ ã§ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºï¼œãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯ 5 ã¤
  - **â‘ ï¼š`test_short` (\*1) â†’`test_long` (\*2) â†’`test_long_uk` (\*3) ã®é †ã«ã€`SELECT COUNT(*) FROM ãƒ†ãƒ¼ãƒ–ãƒ«å`ã‚’ãã‚Œãã‚Œ 10 å›ä»¥ä¸Šé€£ç¶šã§å®Ÿè¡Œã™ã‚‹**
    - `test_short`â†’`test_long`â†’`test_long_uk`ã‚’ 1 ã‚»ãƒƒãƒˆã¨ã—ã¦ 10 å›ç¹°ã‚Šè¿”ã™ã®ã§ã¯ãªãã€`test_short`ã‚’ 10 å›ç¹°ã‚Šè¿”ã—ã¦ã‹ã‚‰`test_long`ã‚’ 10 å›ç¹°ã‚Šè¿”ã™ã€ã¨ã„ã†æ„å‘³ï¼ˆä»¥é™åŒã˜ï¼‰
  - **â‘¡ï¼š`test_short`â†’`test_long_uk`â†’`test_long`ã®é †ã«`SELECT COUNT(*) FROM ãƒ†ãƒ¼ãƒ–ãƒ«å`ã‚’ãã‚Œãã‚Œ 10 å›ä»¥ä¸Šé€£ç¶šã§å®Ÿè¡Œã™ã‚‹**
  - **â‘¢ï¼š`innodb_parallel_read_threads`ã‚’`1`ã«å¤‰æ›´ã—ã¦ã€â‘  ã¨åŒã˜é †ã«`SELECT COUNT(*) FROM ãƒ†ãƒ¼ãƒ–ãƒ«å`ã‚’ãã‚Œãã‚Œ 10 å›ä»¥ä¸Šé€£ç¶šã§å®Ÿè¡Œã™ã‚‹**
    - ä¸¦åˆ—æ•° 1 ã«ãªã‚‹ã‚ˆã†ã«è¨­å®šã‚’å¤‰æ›´
  - **â‘£ï¼šâ‘  ã¨åŒã˜é †ã«`SELECT COUNT(*) FROM ãƒ†ãƒ¼ãƒ–ãƒ«å WHERE id > 0`ã‚’ãã‚Œãã‚Œ 10 å›ä»¥ä¸Šé€£ç¶šã§å®Ÿè¡Œã™ã‚‹**
    - ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã«ãªã‚‰ãªã„ SQL æ–‡ã«å¤‰æ›´
  - **â‘¤ï¼šã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’ r6g.2xlarge ã«å¤‰æ›´ã—ã¦ â‘  ã¨åŒã˜é †ã«`SELECT COUNT(*) FROM ãƒ†ãƒ¼ãƒ–ãƒ«å`ã‚’ãã‚Œãã‚Œ 10 å›ä»¥ä¸Šé€£ç¶šã§å®Ÿè¡Œã™ã‚‹**

(*1) `BLOB`ã‚’å«ã¾ãªã„ãƒ†ãƒ¼ãƒ–ãƒ«
(*2) `BLOB`ã‚’å«ã‚€å¤§å®¹é‡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ10GiB è¶…ï¼‰
(\*3) `BLOB`ã‚’å«ã¿ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŒã¤å¤§å®¹é‡ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåŒä¸Šï¼‰

## ãƒ†ã‚¹ãƒˆç’°å¢ƒ

- AWS ã® RDS for MySQL 8.0.28
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¯ãƒ†ã‚¹ãƒˆ â‘ ã€œâ‘£ ãŒ db.r6g.largeï¼ˆ2vCPUãƒ»Mem 16GiBï¼‰ã€ãƒ†ã‚¹ãƒˆ â‘¤ ãŒ db.r6g.2xlargeï¼ˆ8vCPUãƒ»Mem 64GiBï¼‰
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ gp2 ã® 700GB
- Single-AZ

## ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

ä»¥ä¸‹ã®æ–¹æ³•ã§ç”Ÿæˆã—ã¾ã—ãŸã€‚å…¨ä½“ã§ç´„ 26 GiB ã‚ã‚Šã¾ã™ã€‚

```sql:ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
CREATE DATABASE count_test;
USE count_test;

CREATE TABLE test_short (id INT PRIMARY KEY, val1 INT NOT NULL, val2 INT NOT NULL);
CREATE TABLE test_long (id INT PRIMARY KEY, val1 INT NOT NULL, val2 INT NOT NULL, str1 TEXT);
CREATE TABLE test_long_uk (id INT PRIMARY KEY, val1 INT NOT NULL, val2 INT NOT NULL, str1 TEXT, UNIQUE (val1));

INSERT INTO test_short SET id = 1, val1 = 1, val2 = FLOOR(RAND() * 10);
INSERT INTO test_short SET id = 2, val1 = 2, val2 = FLOOR(RAND() * 10);
ï¼ˆä¸­ç•¥ï¼‰
INSERT INTO test_short SET id = 10, val1 = 10, val2 = FLOOR(RAND() * 10);

INSERT INTO test_long SELECT id, val1, val2, REPEAT('a', FLOOR(100 + RAND() * 9901)) FROM test_short;
INSERT INTO test_long_uk SELECT * FROM test_long;

INSERT INTO test_short SELECT id + 10, val1 + 10, val2 FROM test_short ORDER BY id;
INSERT INTO test_long SELECT id + 10, val1 + 10, val2, str1 FROM test_long ORDER BY id;
INSERT INTO test_long_uk SELECT id + 10, val1 + 10, val2, str1 FROM test_long_uk ORDER BY id;

INSERT INTO test_short SELECT id + 20, val1 + 20, val2 FROM test_short ORDER BY id;
INSERT INTO test_long SELECT id + 20, val1 + 20, val2, str1 FROM test_long ORDER BY id;
INSERT INTO test_long_uk SELECT id + 20, val1 + 20, val2, str1 FROM test_long_uk ORDER BY id;
ï¼ˆä¸­ç•¥ï¼‰
INSERT INTO test_short SELECT id + 1310720, val1 + 1310720, val2 FROM test_short ORDER BY id;
INSERT INTO test_long SELECT id + 1310720, val1 + 1310720, val2, str1 FROM test_long ORDER BY id;
INSERT INTO test_long_uk SELECT id + 1310720, val1 + 1310720, val2, str1 FROM test_long_uk ORDER BY id;
```

## çµæœï¼ˆå˜ä½ï¼šç§’ï¼‰

| å®Ÿè¡Œå›æ•° | â‘ short | â‘ long | â‘ long_uk | â‘¡short | â‘¡long_uk | â‘¡long | â‘¢short | â‘¢long | â‘¢long_uk | â‘£short | â‘£long | â‘£long_uk | â‘¤short | â‘¤long | â‘¤long_uk |
| -------: | -----: | ----: | -------: | -----: | -------: | ----: | -----: | ----: | -------: | -----: | ----: | -------: | -----: | ----: | -------: |
|   1 å›ç›® |   0.93 | 72.30 |    62.56 |   0.40 |    68.50 | 58.21 |   0.42 | 38.28 |    36.10 |   0.81 | 51.94 |    58.15 |   0.84 | 66.37 |    63.46 |
|   2 å›ç›® |   0.08 |  0.33 |    45.13 |   0.08 |     0.34 | 46.88 |   0.34 |  0.85 |    77.66 |   0.64 | 80.50 |    77.20 |   0.04 |  0.18 |     0.17 |
|   3 å›ç›® |   0.09 |  0.36 |    46.65 |   0.08 |     0.34 | 46.70 |   0.34 |  0.84 |    73.98 |   0.64 | 47.61 |    76.93 |   0.04 |  0.17 |     0.17 |
|   4 å›ç›® |   0.08 |  0.32 |    52.16 |   0.09 |     0.33 | 49.13 |   0.34 |  0.85 |    17.55 |   0.63 | 22.79 |    44.45 |   0.04 |  0.18 |     0.17 |
|   5 å›ç›® |   0.09 |  0.33 |    43.03 |   0.08 |     0.33 | 49.49 |   0.34 |  0.84 |    10.92 |   0.63 | 14.38 |    43.64 |   0.04 |  0.18 |     0.18 |
|   6 å›ç›® |   0.08 |  0.35 |    40.14 |   0.09 |     0.33 | 51.86 |   0.34 |  0.84 |    10.23 |   0.63 | 14.28 |    44.40 |   0.04 |  0.17 |     0.17 |
|   7 å›ç›® |   0.08 |  0.34 |    42.18 |   0.08 |     0.33 | 51.62 |   0.34 |  0.84 |     8.96 |   0.63 | 14.18 |    44.06 |   0.05 |  0.17 |     0.17 |
|   8 å›ç›® |   0.08 |  0.33 |    43.05 |   0.09 |     0.32 | 57.11 |   0.34 |  0.85 |     1.32 |   0.64 | 14.26 |    44.60 |   0.04 |  0.17 |     0.17 |
|   9 å›ç›® |   0.10 |  0.33 |    42.12 |   0.08 |     0.33 | 61.55 |   0.34 |  0.83 |     1.01 |   0.63 | 14.42 |    53.88 |   0.05 |  0.17 |     0.17 |
|  10 å›ç›® |   0.11 |  0.33 |    39.24 |   0.09 |     0.33 | 55.76 |   0.34 |  0.84 |     1.00 |   0.63 | 14.27 |    51.60 |   0.04 |  0.18 |     0.18 |

å…¨éƒ¨ã¾ã¨ã‚ã¦è¦‹ã‚‹ã®ã¯é›£ã—ã„ã®ã§é †ã«è¦‹ã¦ã„ãã¾ã™ã€‚

### ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‹ã¤ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºï¼ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºã€ã®å ´åˆ

| å®Ÿè¡Œå›æ•° | â‘ short | â‘ long | â‘ long_uk | â‘¡short | â‘¡long_uk | â‘¡long |
| -------: | -----: | ----: | -------: | -----: | -------: | ----: |
|   1 å›ç›® |   0.93 | 72.30 |    62.56 |   0.40 |    68.50 | 58.21 |
|   2 å›ç›® |   0.08 |  0.33 |    45.13 |   0.08 |     0.34 | 46.88 |
|   3 å›ç›® |   0.09 |  0.36 |    46.65 |   0.08 |     0.34 | 46.70 |
|   4 å›ç›® |   0.08 |  0.32 |    52.16 |   0.09 |     0.33 | 49.13 |
|   5 å›ç›® |   0.09 |  0.33 |    43.03 |   0.08 |     0.33 | 49.49 |
|   6 å›ç›® |   0.08 |  0.35 |    40.14 |   0.09 |     0.33 | 51.86 |
|   7 å›ç›® |   0.08 |  0.34 |    42.18 |   0.08 |     0.33 | 51.62 |
|   8 å›ç›® |   0.08 |  0.33 |    43.05 |   0.09 |     0.32 | 57.11 |
|   9 å›ç›® |   0.10 |  0.33 |    42.12 |   0.08 |     0.33 | 61.55 |
|  10 å›ç›® |   0.11 |  0.33 |    39.24 |   0.09 |     0.33 | 55.76 |

â‘  ã§ã¯ã€`table_short`ãŠã‚ˆã³`table_long`ã«ã¤ã„ã¦ã¯ 1 å›ç›®ã ã‘ãŒé…ãã€2 å›ç›®ä»¥é™ãŒé€Ÿã„ï¼ˆã‹ã¤ã€ã»ã¼åŒã˜æ‰€è¦æ™‚é–“ï¼‰ã§ã™ã€‚æ‰€è¦æ™‚é–“ã‚ˆã‚Š 2 å›ç›®ä»¥é™ã®`SELECT COUNT(*)`ãŒãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã®èª­ã¿å‡ºã—ãªã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

:::message
è¡¨ã«ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãã‚Œãã‚Œã®æ‰€è¦æ™‚é–“ã¯ MySQL 5.7 ä»¥å‰ã¨æ¯”ã¹ã¦ 1 å›ç›®ã“ãã‚ãšã‹ãªé«˜é€ŸåŒ–ã«ã¨ã©ã¾ã‚‹ã‚‚ã®ã®ã€2 å›ç›®ä»¥é™ã¯ 2 å€ä»¥ä¸Šé«˜é€ŸåŒ–ã—ã¦ã„ã¾ã™ã€‚
:::

ã¨ã“ã‚ãŒã€`table_long_uk`ã«ã¤ã„ã¦ã¯ 2 å›ç›®ã«ã‚ãšã‹ã«é€Ÿããªã£ãŸã‚‚ã®ã®ãã®å¾Œã¯æ¨ªã°ã„ã§ãã‚Œä»¥ä¸Šé«˜é€ŸåŒ–ã—ã¦ã„ã¾ã›ã‚“ã€‚CloudWatch ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ç¢ºèªã—ã¦ã¿ãŸã¨ã“ã‚ã€2 å›ç›®ä»¥é™ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿å‡ºã—ãŒç™ºç”Ÿã—ã¦ãŠã‚Šã€

- **`table_long_uk`ã®ãƒ‡ãƒ¼ã‚¿ãƒšãƒ¼ã‚¸ã‚’èª­ã¿å‡ºã™é€”ä¸­ã§ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ãŒã„ã£ã±ã„ã«ãªã£ãŸ**
- **`SELECT COUNT(*)`ã®å‡¦ç†ã§`table_long_uk`ã‚’ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã«è¼‰ã›ã‚‹å‡¦ç†ã«ä½•ã‚‰ã‹ã®å•é¡ŒãŒç”Ÿã˜ã¦ã„ã‚‹ã®ã§ 2 å›ç›®ä»¥é™ã‚‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿å‡ºã—ãŒå¿…è¦ã«ãªã£ã¦ã„ã‚‹**

ã“ã¨ãŒæ¨å¯Ÿã§ãã¾ã™ã€‚

:::message
MySQL 5.7 ä»¥å‰ã§ã¯ã“ã®ã‚ˆã†ãªç¾è±¡ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿å‡ºã—ã«ãªã‚‹ 1 å›ç›®ãŒé…ãã€ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã«ä¹—ã£ã¦ã„ã‚‹ 2 å›ç›®ä»¥é™ã¯é€Ÿããªã‚Šã¾ã™ï¼ˆã‹ã¤ã€ã»ã¼åŒã˜æ‰€è¦æ™‚é–“ï¼‰ã€‚
:::

ç¶šã„ã¦ â‘¡ ã§é †ç•ªã‚’å¤‰ãˆã¦`table_long`ã‚ˆã‚Šå‰ã«`table_long_uk`ã‚’`SELECT COUNT(*)`ã—ãŸã¨ã“ã‚ã€ä»Šåº¦ã¯`table_long_uk`ãŒ 2 å›ç›®ä»¥é™ã‚‚é«˜é€ŸåŒ–ã—ãŸï¼ˆãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã®èª­ã¿å‡ºã—ã«ãªã£ãŸï¼‰ä¸€æ–¹ã§ã€å¾Œã‹ã‚‰å®Ÿè¡Œã—ãŸ`table_long`ã®ã»ã†ã§ 2 å›ç›®ä»¥é™ãŒååˆ†ã«é«˜é€ŸåŒ–ã—ãªã„äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
ã‚„ã¯ã‚Š`table_long`ãƒ»`table_long_uk`ã®æ§‹é€ ã«èµ·å› ã™ã‚‹å•é¡Œã§ã¯ãªãã€ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ãŒã„ã£ã±ã„ã«ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä»¥é™ã«å•é¡ŒãŒç”Ÿã˜ã¦ã„ã‚‹ã¨è¦‹ã¦é–“é•ã„ãªã•ãã†ã§ã™ã€‚

ã©ã†ã‚„ã‚‰ã€ **MySQL 8.0 ã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä»¶ã«å¯¾ã™ã‚‹`SELECT COUNT(*)`ã®å‡¦ç†ã§ã€ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ãŒã„ã£ã±ã„ã«ãªã‚Šå¤ã„ãƒ‡ãƒ¼ã‚¿ãƒšãƒ¼ã‚¸ã‚’è¿½ã„å‡ºã™å¿…è¦ãŒã‚ã‚‹çŠ¶æ³ä¸‹ã®å‡¦ç†ã«å•é¡Œã‚’æŠ±ãˆã¦ã„ã‚‹æ§˜å­** ã§ã™ã€‚

ãªãŠã€`table_long_uk`ã«ã¯ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚MySQL 5.7 ä»¥å‰ã®å‹•ä½œã§ã¯ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ä»•æ§˜ã§ã€ **MySQL 8.0 ã§ã‚‚`EXPLAIN`ã§è¦‹ã‚‹é™ã‚Šã§ã¯ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆï¼ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã®å¯¾è±¡ï¼‰ã§ã¯ãªãã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆï¼ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã®å¯¾è±¡å¤–ï¼‰** ã«ãªã£ã¦ã„ã¾ã—ãŸãŒã€ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã€åŒæ§˜ã®çµæœã«ãªã‚Šã¾ã—ãŸã€‚

### ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚„ã‚ã¦ã¿ã‚‹

å‰è¿°ã®ã¨ãŠã‚Šã€Œã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒã‚ã‚‹`table_long_uk`ã«ã¤ã„ã¦ã‚‚å¾Œã‹ã‚‰`SELECT COUNT(*)`ã™ã‚‹ã¨é…ã„ã€æ™‚ç‚¹ã§ã™ã§ã«æ€ªã—ã„é›°å›²æ°—ã¯ã‚ã‚‹ã®ã§ã™ãŒã€å¿µã®ãŸã‚ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚„ã‚ã‚‹ã¨ã©ã†ãªã‚‹ã®ã‹ã‚’ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚

ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚„ã‚ã‚‹æ–¹æ³•ã¨ã—ã¦ã€

- **â‘¢ï¼š`innodb_parallel_read_threads`ã‚’`1`ã«ã™ã‚‹**
- **â‘£ï¼š`innodb_parallel_read_threads`ã‚’å¤‰ãˆãšã«`WHERE id > 0`ã‚’è¿½åŠ ã™ã‚‹**

ã® 2 ã¨ãŠã‚Šã§è©¦ã—ã¦ã¿ãŸçµæœãŒä»¥ä¸‹ã®è¡¨ã§ã™ã€‚

| å®Ÿè¡Œå›æ•° | â‘¢short | â‘¢long | â‘¢long_uk | â‘£short | â‘£long | â‘£long_uk |
| -------: | -----: | ----: | -------: | -----: | ----: | -------: |
|   1 å›ç›® |   0.42 | 38.28 |    36.10 |   0.81 | 51.94 |    58.15 |
|   2 å›ç›® |   0.34 |  0.85 |    77.66 |   0.64 | 80.50 |    77.20 |
|   3 å›ç›® |   0.34 |  0.84 |    73.98 |   0.64 | 47.61 |    76.93 |
|   4 å›ç›® |   0.34 |  0.85 |    17.55 |   0.63 | 22.79 |    44.45 |
|   5 å›ç›® |   0.34 |  0.84 |    10.92 |   0.63 | 14.38 |    43.64 |
|   6 å›ç›® |   0.34 |  0.84 |    10.23 |   0.63 | 14.28 |    44.40 |
|   7 å›ç›® |   0.34 |  0.84 |     8.96 |   0.63 | 14.18 |    44.06 |
|   8 å›ç›® |   0.34 |  0.85 |     1.32 |   0.64 | 14.26 |    44.60 |
|   9 å›ç›® |   0.34 |  0.83 |     1.01 |   0.63 | 14.42 |    53.88 |
|  10 å›ç›® |   0.34 |  0.84 |     1.00 |   0.63 | 14.27 |    51.60 |

å¾®å¦™ãªçµæœã«ãªã‚Šã¾ã—ãŸã€‚

â‘¢ ã«ã¤ã„ã¦ã¯`table_long_uk`ã® 8 å›ç›®ã®`SELECT COUNT(*)`ã‹ã‚‰ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‚’ä¸Šæ‰‹ãä½¿ãˆã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ãŒã€2 å›ç›®ã¨ 3 å›ç›®ãŒ 1 å›ç›®ã‚ˆã‚Šã‚‚é…ããªã£ã¦ã„ã¾ã™ã€‚

â‘£ ã«ã¤ã„ã¦ã¯`table_long`ã‚‚é…ããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã—ã€`table_long_uk`ã®é€Ÿåº¦ãŒæ”¹å–„ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

:::message
Aurora MySQL v3 ã§ã¯`innodb_parallel_read_threads`ãŒè¨­å®šã§ããªã„ã®ã§ â‘¢ ã®æ–¹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã€‚
ï¼ˆä¸€å¿œã€æ¥ç¶šä¸­ã«`SET`ã¯ã§ãã‚‹ã®ã§ã™ãŒæœ‰åŠ¹ã«æ©Ÿèƒ½ã—ãªã„ã¯ãšã§ã™ï¼‰
:::

### ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‹ã¤ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºï¼œãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºã€ã®å ´åˆ

æœ€å¾Œã«ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å¤§ããã—ã¦ã€ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã‚’ååˆ†ãªå®¹é‡ã«å¢—ã‚„ã—ã¦ã¿ã¾ã—ãŸã€‚

| å®Ÿè¡Œå›æ•° | â‘¤short | â‘¤long | â‘¤long_uk |
| -------: | -----: | ----: | -------: |
|   1 å›ç›® |   0.84 | 66.37 |    63.46 |
|   2 å›ç›® |   0.04 |  0.18 |     0.17 |
|   3 å›ç›® |   0.04 |  0.17 |     0.17 |
|   4 å›ç›® |   0.04 |  0.18 |     0.17 |
|   5 å›ç›® |   0.04 |  0.18 |     0.18 |
|   6 å›ç›® |   0.04 |  0.17 |     0.17 |
|   7 å›ç›® |   0.05 |  0.17 |     0.17 |
|   8 å›ç›® |   0.04 |  0.17 |     0.17 |
|   9 å›ç›® |   0.05 |  0.17 |     0.17 |
|  10 å›ç›® |   0.04 |  0.18 |     0.18 |

å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒšãƒ¼ã‚¸ãŒå…¨éƒ¨ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã«è¼‰ã‚‹å ´åˆã¯ä½•ã®å•é¡Œã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

:::message
çµæœã¯è¼‰ã›ã¦ã„ã¾ã›ã‚“ãŒã€ã“ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã§ã‚‚ãƒ‡ãƒ¼ã‚¿å®¹é‡ã‚’ 4 å€ã«ã™ã‚‹ã¨åŒã˜å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚
:::

## ç¾æ™‚ç‚¹ã§ã®çµè«–

ã€Œå…¨ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºï¼œãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºã€ã§é‹ç”¨ã™ã‚‹ã®ã¯ç¾å®Ÿçš„ã§ã¯ãªã„ã®ã§ã€æœ‰åŠ¹ãªå›é¿ç­–ãŒè¦‹ã¤ã‹ã‚‰ãšå›°ã£ã¦ã„ã¾ã™ã€‚

ã€Œ10 GiB ã‚’è¶…ãˆã‚‹ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ä»¶`SELECT COUNT(*)`ã¯å–ã‚‹ãªã€ã¨è¨€ã‚ã‚Œã‚Œã°ãã®ã¨ãŠã‚Šãªã®ã§ã™ãŒã€‚

## ä½™è«‡

ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã®`SELECT COUNT(*)`ã«ã¤ã„ã¦ã¯ä»¥å‰ã‹ã‚‰ã„ãã¤ã‹ã®ãƒã‚°ãŒè¦‹ã¤ã‹ã£ã¦ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚

### [MySQL 8.0.24 ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ](https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-24.html#mysqld-8-0-24-bug)ã‚ˆã‚Š

> - **_InnoDB:_** On Windows, stalls were caused by concurrent SELECT COUNT(\*) queries where the number of parallel read threads exceeded the number of machine cores. **(Bug #32224707, Bug #101789)**

### [MySQL 8.0.26 ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ](https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-26.html#mysqld-8-0-26-bug)ã‚ˆã‚Š

> - **_InnoDB:_** Stalls were caused by concurrent SELECT COUNT(\*) queries where the number of parallel read threads exceeded the number of machine cores. A patch for this issue was provided for Windows builds in MySQL 8.0.24. The MySQL 8.0.26 patch addresses the same issue on other affected platforms. **(Bug #32678019)**

ãŸã ã—ã€ã¾ã  Fix ã•ã‚Œã¦ã„ãªã„ãƒã‚°ã‚‚æ®‹ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ï¼ˆ2022/07/22 ç¾åœ¨ï¼‰ã€‚

https://bugs.mysql.com/bug.php?id=99717
