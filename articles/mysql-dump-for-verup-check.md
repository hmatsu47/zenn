---
title: "小ネタ／MySQL でバージョンアップ時のデータ整合確認に mysqldump を使う"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["mysql", "移行", "バージョンアップ", "mysqldump"]
published: false
---

データ移行作業そのものではなく、データ移行作業時の整合チェックに `mysqldump` を使う小ネタです。

## いつ使う？

MySQL（または RDS / Aurora などの互換サービス）でバージョンアップを行う際に、binlog あるいは DMS（CDC）などによってデータを旧バージョン → 新バージョンにレプリケーションし、新バージョンへの切り替え時のダウンタイム短縮をはかるケースがあります。

その際、（ダウンタイムとのトレードオフで）ある程度データの整合性チェックをした上で新バージョンへ切り替えたいこともあるでしょう。

同じバージョンの MySQL サーバ間のテーブル整合性確認には _`CHECKSUM TABLE`_ コマンドが使えますが、バージョンを跨ぐ場合はサーバの内部的なデータフォーマットの変更によってチェックサムに差異が生じることがあるので、必ず使えるわけではありません。
また、バージョンアップではありませんが、例えば文字セットを 3 バイトの `utf8` から `utf8mb4` に変更するケースでも使えません。

そんなときに今回の小ネタを使うと良いかもしれません。

## どう使う？

- サイズが小さいテーブルや、重要度が高いテーブルを対象として `mysqldump` でデータをダンプする
  - _`mysqldump -u ユーザ名 -h サーバのアドレス／エンドポイント -p --default-character-set=デフォルト文字セット -t --skip-comments --max_allowed_packet=1G --hex-blob データベース名 [テーブル名] > 出力ファイル`_
  - できるだけデータベース（スキーマ）単位でまとめて出力しておくと、後の比較（ハッシュ値による）が楽
- サイズが大きいか、重要度がそれほど高くないテーブルは行数と新しいほうから一定行数を `SELECT` でテキストファイルに書き出す
  - _`SELECT COUNT(*) FROM データベース名.テーブル名`_
  - _`SELECT * FROM データベース名.テーブル名 ORDER BY (*)主キー列など DESC LIMIT 行数`_
    - (\*) は主キー列が `AUTO_INCREMENT` ならそれをそのまま使い、そうでなければ _`登録日時列 DESC 主キー列 DESC`_ のようにする
    - テーブルに `BLOB` 列がある場合はその列を`SHA2()` 関数などでハッシュ化して書き出す
- 実行時間を短縮するため、サーバ負荷が 100% に到達しない範囲でダンプ＆テキストファイル書き出しを並列で実行する
  - それぞれがほぼ均等な時間で出力完了するように
- 最終的にこれらの結果のハッシュ値を MD5 や SHA2 で計算して新旧データの整合性確認
  - Linux のマシンからダンプを取る場合は、出力先のディレクトリに移動して _`md5sum * > 出力ファイル`_ または _`sha224sum * > 出力ファイル`_
    - どちらか一方の出力ファイルを他方にコピーして `diff` で比較する
  - ハッシュ値の差異が見つかったら、対象のファイルだけどちらか一方から他方へコピーして `diff` で比較し差異があるテーブル・行を特定する

## 注意点

- MySQL 5.6 ⇔ MySQL 8.0 の場合、8.0 の `mysqldump` で 5.6 サーバのデータをダンプできない
  - MySQL 5.6 サーバには MySQL 5.6 クライアント付属の `mysqldump` を、MySQL 8.0 サーバには MySQL 8.0 クライアント付属の `mysqldump` を使う
    - このケースでは、GTID に関連する出力など一部不一致行が生じるので、MySQL 8.0 では以下のように `sed` で置換／行削除する
      - _`mysqldump -u ユーザ名 -h エンドポイント -p --default-character-set=デフォルト文字セット -t --skip-comments --max_allowed_packet=1G --hex-blob データベース名 [テーブル名] | sed -e '/^SET @/d' -e '5s/50503/40101/' > 出力ファイル`_
- ダンプを実行するマシンにはダンプ容量＋差異の比較時に必要な容量分のストレージが必要
