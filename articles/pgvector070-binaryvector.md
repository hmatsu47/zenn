---
title: "pgvector 0.7.0 でバイナリインデックス＆量子化を試してみた"
emoji: "⬆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["postgresql", "pgvector", "embeddings"]
published: true
---

先日 Qiita に書いた[こちら ↓ の記事](https://qiita.com/hmatsu47/items/8cdafc093fcda793e863)の内容が [README](https://github.com/pgvector/pgvector?tab=readme-ov-file) 丸写しすぎたので、バイナリ（ビット）インデックスと量子化の効果を少しだけ試してみました。

https://qiita.com/hmatsu47/items/8cdafc093fcda793e863

## やったこと

以下の構成で、インデックスの作成とベクトル検索の所要時間を確認・比較しました。

- 環境 : いずれも AWS オレゴン（us-west-2）リージョン
  - データベース : RDS for PostgreSQL 16.3
    - db.m6g.large（2vCPU・8GB Mem）
    - pgvector 0.7.0 をサポート
  - Embeddings モデル : Amazon Bedrock Titan Text Embeddings V2
    - 1024 次元
    - 正規化あり
- 使用データ
  - https://huggingface.co/datasets/takaaki-inada/databricks-dolly-15k-ja-zundamon
    - 2024/5/22 時点のデータ
    - そのうち、`output`に値があり、Titan Text Embeddings V2 でトークンサイズが 8,192 を超えないもの（4,594 件）
    - `output`と`instruction`をそれぞれ個別の行としてテーブルに登録（計 9,188 行）
    - データ行に登録するベクトルは 32 ビット float 値
- インデックス : 以下の作成時間と検索時間を比較
  - インデックスなし
    - ベクトル検索（内積）で`instruction`の 1 行目に近いほうから 5 件の`output`行を抽出
  - 32 ビット float 値の HNSW インデックス
    - 同上（インデックスを使う）
  - バイナリ（ビット）インデックス
    - 32 ビット float 値をバイナリ量子化
    - インデックスを使ってベクトル検索（ハミング距離）して 20 件に絞り込んだものを 32 ビット float 値の内積で 5 件の`output`行を抽出

:::message
ベクトル（32 ビット float）の値を -1 〜 1 の範囲に正規化しているので、コサイン類似度ではなく内積を使っています。
:::

### データ投入

[こちらにある Python スクリプト](https://github.com/hmatsu47/pgvector070-test/blob/main/app_titan2_re_rank_bin_index_text.py)を使ってデータを投入しました。

https://github.com/hmatsu47/pgvector070-test/blob/main/app_titan2_re_rank_bin_index_text.py

:::message
RDS for PostgreSQL や Amazon Bedrock のモデル、実行環境の IAM ロール／ポリシー設定など詳細は省略します。
（後日 [README](https://github.com/hmatsu47/pgvector070-test/blob/main/README.md) に追記予定）
:::

### インデックスがない状態でベクトル検索

```sql:質問文
postgres=> SELECT id, data FROM rerank_test WHERE id = 100000;
-[ RECORD 1 ]----------------------------------------------------------
id   | 100000
data | ヴァージン・オーストラリア航空はいつから運航を開始したのですか？

Time: 139.100 ms
```

この質問文（`instruction`）に近い内容の回答（`output`）を抽出しました。

```sql:インデックスなしの結果
postgres=> SELECT id, (embedding <#> (SELECT embedding FROM rerank_test WHERE id = 100000)) * -1 AS inner_product, data FROM rerank_test WHERE id < 100000 ORDER BY inner_product DESC LIMIT 5;
-[ RECORD 1 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 0
inner_product | 0.7999640703201294
data          | ヴァージン・オーストラリア航空（Virgin Australia Airlines Pty Ltd）はオーストラリアを拠点とするヴァージン・ブランドを冠する最大の船団規模を持つ航空会社なのだ。2000年8月31日に、ヴァージン・ブルー空港として、2機の航空機、1つの空路を運行してサービスを開始しました。2001年9月のアンセット・オーストラリア空港の崩壊後、オーストラリアの国内市場で急速に地位を確立しました。その後はブリスベン、メルボルン、シドニーをハブとして、オーストラリア国内の32都市に直接乗り入れるまでに成長しました。
-[ RECORD 2 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3355
inner_product | 0.4171184301376343
data          | N.V. Virgin Express S.A.は、ヴァージン・グループ内に誕生したベルギーの航空会社なのだ。ブリュッセル空港をハブ空港として、主に南欧方面へのフライトを運航していました。航空券は主にインターネットを通じて販売されました。SNブリュッセル航空と合併してブリュッセル航空となり、2007年3月25日に運航を開始した。 バージン・エクスプレスの本社はブリュッセル近郊のベルギー・ザベンタムのブリュッセル空港の116号館にある。                                                                                                                                                                                                                                                              +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | 沿革                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
              | 1996年4月23日、ヴァージン・グループ（会長リチャード・ブランソン）は、ビクター・ハッソンとジョルジュ・グーテルマンが設立したベルギーのレジャー航空会社EBA - ユーロベルジアン・エアラインズを買収し、ヴァージン・エクスプレスのブランド名に改名しました またEBAのボーイング737を引き継ぎ、以降このタイプの航空機で運行しました。すぐにブリュッセルのハブ空港から低予算の定期便に集中し、サベナや後のSNブリュッセル航空の主要な競争相手となった。                                                                                                                                                                                                                                 +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | 2004年10月、ヴァージン・グループはSNブリュッセル航空に資産を売却し、両航空会社はエチエンヌ・ダヴィニョン子爵が会長を務める親会社の持ち株会社SNエアホールディングに統合されました。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | 2006年3月31日、SNブリュッセル航空とヴァージン・エクスプレスは合併し、ブリュッセル航空と命名したことを発表しました。統合後の航空会社は長距離路線を追加し、アフリカでの地位を強化した。
-[ RECORD 3 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 6819
inner_product | 0.2454237937927246
data          | OA形は、ボールドウィン機関車製作所がニュージーランドのウェリントン＆マナワツ鉄道（WMR）のために製作した孤高の蒸気機関車なのだ。1894年に発注され、同年8月に13号機として運行を開始し、世界初のナローゲージのヴォークレイン配合となりました。1908年、WMRとその機関車群はニュージーランド鉄道局（NZR）に買収され、全国鉄道網に組み込まれた。13号機はOクラスのメンバーとは似ているが、十分に異なるため、別の分類が必要なのだ。13号車はO型に似ていたが、十分な違いがあり、別の分類が必要であったため、OAという名称が作られ、OA 457という番号が付けられた。1929年12月にオークランドで撤去されるまで、さらに20年間運行された。この機関車はWMRのスタッフには「The Lady」と呼ばれていた。
-[ RECORD 4 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 1540
inner_product | 0.22488926351070404
data          | 橋が架かる前、サンフランシスコと現在のマリン郡を結ぶ唯一の実用的な近道は、サンフランシスコ湾の一角を船で渡ることであった。1820年には早くもフェリーの運航が始まり、1840年代にはサンフランシスコへの水運を目的とした定期運航が開始された。                                                                                                                                                                                                                                                                                                                                                                                                                                       +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | 1867年に開始されたサウサリート・ランド・アンド・フェリー・カンパニーのサービスは、やがてサザン・パシフィック鉄道の子会社であるゴールデン・ゲート・フェリー・カンパニーとなり、1920年代後半には世界最大のフェリー運航会社となりました。かつては鉄道の乗客や顧客だけのものだったサザン・パシフィックの自動車フェリーは、非常に収益性が高く、地域経済にとって重要なものとなりました。サンフランシスコのハイド・ストリート・ピアとマリン郡のサウサリート・フェリー・ターミナルを結ぶフェリーの所要時間は約20分、料金は車1台につき1ドルだった[when?]が、後に新しい橋に対抗するために値下げされた。サンフランシスコ・フェリー・ビルディングからの所要時間は27分であった。
-[ RECORD 5 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3120
inner_product | 0.22459137439727783
data          | Oy Air Finlandは、フィンランドのヴァンターにあるヘルシンキ空港を本社・拠点とする航空会社で、休暇先へのチャーター便や定期便、航空機リースサービスを行っていました。2002年に創業し、2012年に破産を申請しているのだ。                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | 沿革                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | カンゲルルススアーク空港の旧カラーリングのボーイング757-200（2010年）。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | マラガ空港で最新のカラーリングを施したボーイング757-200（2012年）。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
              | リーズ・ブラッドフォード国際空港で、Jet2 Holidaysの基本カラーをまとった元エア・フィンランド航空のボーイング757-200（2011年）。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
              | 2002年1月に設立され、2003年4月3日に運航を開始した航空会社なのだ。航空業界、金融業界、旅行マーケティング業界出身の3人によって所有されていました：Harri Naivo（会長兼最高財務責任者）、Mika Helenius（最高経営責任者）、Lauri Komi。2007年3月時点の従業員数は210名であった。2012年6月26日、エア・フィンランドはすべてのフライトを直ちにキャンセルすることを発表し、破産を申請した。

Time: 173.794 ms
```

データ量が少ないので 0.17 秒程度でした。

### 32 ビット float インデックス（HNSW）を作成して検索

まずはインデックスを作成します。

```sql:通常インデックス（HNSW）作成
postgres=> CREATE INDEX ON rerank_test USING hnsw (embedding vector_ip_ops);
CREATE INDEX
Time: 9103.665 ms (00:09.104)
```

9.1 秒かかりました。

この状態で、先ほどと同じ検索を行います。

```sql:通常インデックスありの結果
postgres=> SELECT id, (embedding <#> (SELECT embedding FROM rerank_test WHERE id = 100000)) * -1 AS inner_product, data FROM rerank_test WHERE id < 100000 ORDER BY inner_product DESC LIMIT 5;
-[ RECORD 1 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 0
inner_product | 0.7999640703201294
data          | ヴァージン・オーストラリア航空（Virgin Australia Airlines Pty Ltd）はオーストラリアを拠点とするヴァージン・ブランドを冠する最大の船団規模を持つ航空会社なのだ。2000年8月31日に、ヴァージン・ブルー空港として、2機の航空機、1つの空路を運行してサービスを開始しました。2001年9月のアンセット・オーストラリア空港の崩壊後、オーストラリアの国内市場で急速に地位を確立しました。その後はブリスベン、メルボルン、シドニーをハブとして、オーストラリア国内の32都市に直接乗り入れるまでに成長しました。
-[ RECORD 2 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3355
inner_product | 0.4171184301376343
data          | N.V. Virgin Express S.A.は、ヴァージン・グループ内に誕生したベルギーの航空会社なのだ。ブリュッセル空港をハブ空港として、主に南欧方面へのフライトを運航していました。航空券は主にインターネットを通じて販売されました。SNブリュッセル航空と合併してブリュッセル航空となり、2007年3月25日に運航を開始した。 バージン・エクスプレスの本社はブリュッセル近郊のベルギー・ザベンタムのブリュッセル空港の116号館にある。                                                                                                                                                                                                                                                              +
（中略）
-[ RECORD 3 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 6819
inner_product | 0.2454237937927246
data          | OA形は、ボールドウィン機関車製作所がニュージーランドのウェリントン＆マナワツ鉄道（WMR）のために製作した孤高の蒸気機関車なのだ。1894年に発注され、同年8月に13号機として運行を開始し、世界初のナローゲージのヴォークレイン配合となりました。1908年、WMRとその機関車群はニュージーランド鉄道局（NZR）に買収され、全国鉄道網に組み込まれた。13号機はOクラスのメンバーとは似ているが、十分に異なるため、別の分類が必要なのだ。13号車はO型に似ていたが、十分な違いがあり、別の分類が必要であったため、OAという名称が作られ、OA 457という番号が付けられた。1929年12月にオークランドで撤去されるまで、さらに20年間運行された。この機関車はWMRのスタッフには「The Lady」と呼ばれていた。
-[ RECORD 4 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 1540
inner_product | 0.22488926351070404
data          | 橋が架かる前、サンフランシスコと現在のマリン郡を結ぶ唯一の実用的な近道は、サンフランシスコ湾の一角を船で渡ることであった。1820年には早くもフェリーの運航が始まり、1840年代にはサンフランシスコへの水運を目的とした定期運航が開始された。                                                                                                                                                                                                                                                                                                                                                                                                                                       +
（中略）
-[ RECORD 5 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3120
inner_product | 0.22459137439727783
data          | Oy Air Finlandは、フィンランドのヴァンターにあるヘルシンキ空港を本社・拠点とする航空会社で、休暇先へのチャーター便や定期便、航空機リースサービスを行っていました。2002年に創業し、2012年に破産を申請しているのだ。                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
（中略）

Time: 175.982 ms
```

インデックスなしと抽出結果は変わらず、所要時間もほぼ変わりませんでした。

### バイナリ（ビット）インデックス（HNSW）を作成して Re-rank 検索

続いて今回のメインテーマ、バイナリインデックス＆量子化です。

まずは（先ほどのインデックスを削除してから）インデックスを作成します。

```sql:通常インデックス削除
postgres=> \di
List of relations
-[ RECORD 1 ]---------------------
Schema | public
Name   | rerank_test_embedding_idx
Type   | index
Owner  | postgres
Table  | rerank_test
-[ RECORD 2 ]---------------------
Schema | public
Name   | rerank_test_pkey
Type   | index
Owner  | postgres
Table  | rerank_test

postgres=> DROP INDEX rerank_test_embedding_idx;
DROP INDEX
Time: 152.619 ms
```

```sql:バイナリインデックス（HNSW）作成
postgres=> CREATE INDEX ON rerank_test USING hnsw ((binary_quantize(embedding)::bit(1024)) bit_hamming_ops);
CREATE INDEX
Time: 3356.522 ms (00:03.357)
```

3.4 秒ほどでした。通常の 32 ビット float インデックスより速いですね。

そして、このインデックスを使ってハミング距離が近い順に 20 件絞り込んでから、32 ビット float ベクトルの内積で近い順に 5 件抽出します。

```sql:バイナリインデックスで Re-rank
postgres=> SELECT id, (embedding <#> (SELECT embedding FROM rerank_test WHERE id = 100000)) * -1 AS inner_product, data FROM (SELECT * FROM rerank_test WHERE id < 100000 ORDER BY binary_quantize(embedding)::bit(1024) <~> (SELECT binary_quantize(embedding)::bit(1024) FROM rerank_test WHERE id = 100000) LIMIT 20) ORDER BY inner_product DESC LIMIT 5;
-[ RECORD 1 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 0
inner_product | 0.7999640703201294
data          | ヴァージン・オーストラリア航空（Virgin Australia Airlines Pty Ltd）はオーストラリアを拠点とするヴァージン・ブランドを冠する最大の船団規模を持つ航空会社なのだ。2000年8月31日に、ヴァージン・ブルー空港として、2機の航空機、1つの空路を運行してサービスを開始しました。2001年9月のアンセット・オーストラリア空港の崩壊後、オーストラリアの国内市場で急速に地位を確立しました。その後はブリスベン、メルボルン、シドニーをハブとして、オーストラリア国内の32都市に直接乗り入れるまでに成長しました。
-[ RECORD 2 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3355
inner_product | 0.4171184301376343
data          | N.V. Virgin Express S.A.は、ヴァージン・グループ内に誕生したベルギーの航空会社なのだ。ブリュッセル空港をハブ空港として、主に南欧方面へのフライトを運航していました。航空券は主にインターネットを通じて販売されました。SNブリュッセル航空と合併してブリュッセル航空となり、2007年3月25日に運航を開始した。 バージン・エクスプレスの本社はブリュッセル近郊のベルギー・ザベンタムのブリュッセル空港の116号館にある。                                                                                                                                                                                                                                                              +
（中略）
-[ RECORD 3 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 6819
inner_product | 0.2454237937927246
data          | OA形は、ボールドウィン機関車製作所がニュージーランドのウェリントン＆マナワツ鉄道（WMR）のために製作した孤高の蒸気機関車なのだ。1894年に発注され、同年8月に13号機として運行を開始し、世界初のナローゲージのヴォークレイン配合となりました。1908年、WMRとその機関車群はニュージーランド鉄道局（NZR）に買収され、全国鉄道網に組み込まれた。13号機はOクラスのメンバーとは似ているが、十分に異なるため、別の分類が必要なのだ。13号車はO型に似ていたが、十分な違いがあり、別の分類が必要であったため、OAという名称が作られ、OA 457という番号が付けられた。1929年12月にオークランドで撤去されるまで、さらに20年間運行された。この機関車はWMRのスタッフには「The Lady」と呼ばれていた。
-[ RECORD 4 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 1540
inner_product | 0.22488926351070404
data          | 橋が架かる前、サンフランシスコと現在のマリン郡を結ぶ唯一の実用的な近道は、サンフランシスコ湾の一角を船で渡ることであった。1820年には早くもフェリーの運航が始まり、1840年代にはサンフランシスコへの水運を目的とした定期運航が開始された。                                                                                                                                                                                                                                                                                                                                                                                                                                       +
（中略）
-[ RECORD 5 ]-+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
id            | 3120
inner_product | 0.22459137439727783
data          | Oy Air Finlandは、フィンランドのヴァンターにあるヘルシンキ空港を本社・拠点とする航空会社で、休暇先へのチャーター便や定期便、航空機リースサービスを行っていました。2002年に創業し、2012年に破産を申請しているのだ。                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
（中略）

Time: 140.448 ms
```

抽出結果は変わらず、所要時間は先ほどより若干短く 0.14 秒になりました。

:::message
ここでは省略しましたが、複数回実行してばらつきがほとんどないことを確認しています。
:::

データ量が少ないので効果は出ないかと思いましたが、意外と効果が出ました。

## まとめ

- バイナリ量子化でインデックスの容量を削減することにより、インデックス作成時間を短縮できる
- データがそれほど多いテーブルでなくても、バイナリインデックスである程度絞り込んでから本来の精度でバイナリ検索する方法（Re-rank）を使うと、検索時間を短縮できる可能性がある
  - データによっては精度が落ちたり検索時間の短縮ができない可能性はある
