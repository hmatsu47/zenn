---
title: "Amazon Aurora MySQL v1（5.6 互換）→ v3（8.0 互換）移行を計画する（8）動作確認"
emoji: "👈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "aurora", "mysql"]
published: false
---

これは

- **[Amazon Aurora MySQL v1（5.6 互換）→ v3（8.0 互換）移行を計画する（7）パラメータ・コード確認](/hmatsu47/articles/aurora-mysql3-007-research-02)**

の続きです。

パラメータグループやアプリケーション・コード（SQL 文）を修正後、実際の環境で確認します。

# 確認環境構築のポイント

## 1. 実際の移行方法や移行パスを意識する

最初の構築時は差分レプリケーション（CDC）まで意識する必要はないと思いますが、少なくとも

- スナップショット復元（v1 → v2、v2 → v3）
- インプレースアップグレード（v1 → v2）＋スナップショット復元（v2 → v3）
- テーブル設計（インデックス等を含む）のダンプ＆リストア＋DMS によるデータ移行＋ユーザ権限移行
- MySQL Shell の `dumpInstance()` & `loadDump()`＋ユーザ権限移行
  - 参考 : **[Aurora MySQL バージョン 1（5.6 互換）→バージョン 3（8.0 互換）間の dumpInstance() & loadDump() を試す](https://qiita.com/hmatsu47/items/9db2ad8e8f41e44a54b7)**

など、実際の移行作業で使う方法や移行パスを意識して確認環境を用意したほうが良いです。

この作業には必ずしも本番データ相当のデータを使う必要はありませんが、方法やパスを合わせておくことで、早い段階で作業上の問題点を顕在化させることができます。

私が関わっているサービスの場合、以下のような問題点とその原因、および対処法を見つけることができました。

https://qiita.com/hmatsu47/items/d3f34f39c28a4b802966

## 2. 実際の構成を意識する

この段階では必ずしも実環境と同じサイズと個数のインスタンスを用意する必要はありませんが（アプリケーションコードがインスタンスサイズや個数に依存している場合を除いて）、Reader インスタンスを使用する構成であれば必ず Reader インスタンスを用意します。

これは、以前の記事に示したとおり、 **[一時テーブルの仕様変更](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/AuroraMySQL.MySQL80.html#AuroraMySQL.mysql80-temp-tables-readers)** などの影響が生じないか確認するのが目的です。

またその際、実際の AZ 構成を意識してインスタンスを配置します。

## 3. 一通り動作確認を完了したら差分レプリケーションや DMS の CDC をテストする

binlog による v1 → v3 差分レプリケーションは（v1 → v2 → v3 の多段レプリケーションを含め）非推奨ですし、DMS の CDC による差分レプリケーションにもいくつかの制約事項があります。

差分レプリケーション（CDC）を使ってメンテナンス停止時間の短縮をはかる場合は、アプリケーションの動作確認後、移行パスを正式に決める前にレプリケーションに支障がないかを必ず確認しておきます。

何らかの問題点が見つかった場合はそれを修正するか、別の方法での移行を検討します。
