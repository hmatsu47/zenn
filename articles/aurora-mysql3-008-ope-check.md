---
title: "Amazon Aurora MySQL v1（5.6 互換）→ v3（8.0 互換）移行を計画する（8）動作確認"
emoji: "👈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws", "aurora", "mysql", "移行", "バージョンアップ"]
published: true
---

これは

- **[Amazon Aurora MySQL v1（5.6 互換）→ v3（8.0 互換）移行を計画する（7）パラメータ・コード確認](/hmatsu47/articles/aurora-mysql3-007-research-02)**

の続きです。

パラメータグループやアプリケーション・コード（SQL 文）を修正後、実際の環境で確認します。

## 確認内容

主に、

- **a. 移行前後で動作が変わらないこと**
- **b. 移行後に性能が低下しないこと**

を確認します。

また、移行作業にレプリケーション（DMS の CDC）を使う場合は、動作確認後に

- **c. レプリケーションのテスト**

も行います。

## 確認環境構築のポイント

### 1. 実際の移行方法や移行パスを意識する

確認環境構築時には、

- **スナップショット復元（v1 → v2、v2 → v3）**
- **インプレースアップグレード（v1 → v2）＋スナップショット復元（v2 → v3）**
- **テーブル設計（インデックス等を含む）のダンプ＆リストア＋ DMS によるデータ移行＋ユーザ権限移行**
- **MySQL Shell の `dumpInstance()` & `loadDump()`（またはその他のテーブルダンプ・リストアツール）＋ユーザ権限移行**
  - **参考 : [Aurora MySQL バージョン 1（5.6 互換）→ バージョン 3（8.0 互換）間の dumpInstance() & loadDump() を試す](https://qiita.com/hmatsu47/items/9db2ad8e8f41e44a54b7)**

など、実際の移行作業で使う方法や移行パスを意識して進めるのが望ましいです。

a.（動作の変化がないか確認）では必ずしも実容量を意識してテストデータを用意する必要はありませんが、移行の方法やパスを合わせておくことで、早い段階で作業上の問題点を顕在化させることができます。

私が関わっているサービスの場合、以下のような問題点とその原因、および対処法を見つけることができました。

- **[管理者権限が移行されない](https://qiita.com/hmatsu47/items/d3f34f39c28a4b802966#%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E5%95%8F%E9%A1%8C%E3%81%9D%E3%81%AE-1--%E7%AE%A1%E7%90%86%E8%80%85%E6%A8%A9%E9%99%90%E3%81%8C%E7%A7%BB%E8%A1%8C%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84)**
- **[一部のユーザの権限が無効になる（アクセスが拒否される）](https://qiita.com/hmatsu47/items/d3f34f39c28a4b802966#%E7%99%BA%E7%94%9F%E3%81%97%E3%81%9F%E5%95%8F%E9%A1%8C%E3%81%9D%E3%81%AE-2--%E4%B8%80%E9%83%A8%E3%81%AE%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E6%A8%A9%E9%99%90%E3%81%8C%E7%84%A1%E5%8A%B9%E3%81%AB%E3%81%AA%E3%82%8B%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%8C%E6%8B%92%E5%90%A6%E3%81%95%E3%82%8C%E3%82%8B)**

なお、b.（性能テスト）ではできるだけ実容量を意識してテストデータを用意します。

### 2. 実際の構成を意識する

a. では必ずしも実環境と同じサイズと個数のインスタンスを用意する必要はありませんが（アプリケーションコードがインスタンスサイズや個数に依存している場合を除いて）、Reader インスタンスを使用する構成であれば必ず Reader インスタンスを用意します。

これは、以前の記事に示したとおり、 **[テンポラリテーブルの仕様変更](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/ams3-temptable-behavior.html#ams3-temptable-behavior.user)** などの影響が生じないか確認するのが目的です。

またその際、実際の AZ 構成を意識してインスタンスを配置します。

b. では実環境と同じサイズと個数のインスタンスを用意します。

### 3. 移行前後で比較可能にする

a.・b. いずれも、移行前後の比較が可能なように、同じデータをもとに同じ構成の環境を Aurora MySQL v1 と v3 のそれぞれについて用意し、動作や性能を直接比較できるようにするのが望ましいです。

経験上、システム移行でアプリケーションの既存バグを見つけることが多いのですが、比較対象の環境を用意しているとそれが既存バグか動作の非互換かを判別しやすいです（後者の場合は同様の実装を行っている箇所の動作確認をすべき）。

性能テストの際も同じデータに対して同じ負荷を掛けることで、移行後に性能低下するかどうかを判別しやすいです。

:::message
Aurora MySQL v3 では本家 MySQL 8.0 由来のハッシュ結合が導入されており、この機能を使う場合は結合バッファを大きめに確保するのが望ましいです。
結合バッファのサイズを大きくするには、以下の 2 通りの方法があります。

- **パラメータグループで`join_buffer_size`を上げる**
  - アプリケーションの修正は不要だが、全体的にメモリの使用量が増える欠点がある
- **ハッシュ結合を使う SQL 文に`SET_VAR`ヒントを記述して個別に大きめの`join_buffer_size`を指定する**
  - アプリケーションの修正が必要だが、メモリの使用量増加を最小限に抑えられる

:::

:::message
**動作確認でわかったこと：`SELECT COUNT(*)`が遅くなるケースがある**

`WHERE`句や`GROUP BY`句のないテーブル全件の`SELECT COUNT(*)`は MySQL 8.0.14 からパラレル処理で高速化されたのですが、Aurora MySQL 3.02.0 時点ではある程度行数が多いテーブルでは CPU 使用率が 100% に到達するとともに、Aurora MySQL v2 以前と比べても時間が掛かるケースがあるようです。

- **[MySQL 8.0 で SELECT COUNT(\*) が失速する](https://zenn.dev/hmatsu47/articles/mysql80-count-slowdown#fnref-52c5-1)**

:::

:::message
**2022/10/18 追記：**
動作確認時、潜在的なバグが（Aurora MySQL v3 あるいは MySQL Connector の SQL 文解釈の厳格化によって）エラーや予期せぬ挙動の変化によって顕在化することがあります。

例えば、文字列（空文字列を含む）を日付と比較する場合、以前であればエラーにならずに単なる文字列比較として処理されていたものがエラーになる、などです。

- **[MySQL 8.0.15 の前後で変わった文字列と DATE 型の比較について](https://rabbitfoot141.hatenablog.com/entry/2020/07/01/215728)（それが僕には楽しかったんです。／けんつさん）**

:::

### 4. 一通り動作確認を完了したら差分レプリケーション（DMS の CDC）をテストする

binlog による v1 → v3 差分レプリケーションは（v1 → v2 → v3 の多段レプリケーションを含め）非推奨です。

そのため、差分レプリケーションを使ってメンテナンス停止時間の短縮をはかる場合は次のような流れで DMS の CDC を使用することになります。

1. あるタイミングのクローン＆スナップショットから v3 クラスタを作成
2. v1 クラスタから v3 クラスタに差分データのレプリケーションを開始
3. 移行当日になったらサービスを一時停止し、Web サーバ等からの接続を v3 クラスタに切り替え
4. 動作確認を行い、問題がなければサービスを再開

- **図 1 ：DMS レプリケーション（CDC）を使う移行の構成例・移行準備段階（1. 〜 2.）**

![](/images/aurora-mysql3-plan-book/dms_replication_before.png)

- **図 2 ：DMS レプリケーション（CDC）を使う移行の構成例・移行直後（3. 〜 4.）**

![](/images/aurora-mysql3-plan-book/dms_replication_after.png)

DMS（CDC）によるレプリケーションにもいくつかの制約事項があるため、アプリケーションの動作確認後、移行パスを正式に決める前にレプリケーションに支障がないかを必ず確認しておきます。

何らかの問題点が見つかった場合はそれを修正するか、別の方法での移行を検討します。

例えば、以下のような問題が見つかる可能性があります。

- **`time`型の列が移行されない**
- **`float`型の列が移行されない**

それぞれ、テーブルマッピングの変換ルールで該当列の型変換を指定します。

- `time`型（扱う値の範囲が 24 時間以内の場合）
  - MySQL の`time`型は DMS では`string`型として扱われるので`time`型に変換する
- `float`型（精度の指定がない場合）
  - DMS の`real4`型に変換する

また、

- **`blob`型の列の更新が無視される**

ケースでは、

- タスク設定で完全 LOB モードを指定しているか？
- アプリケーションで`blob`型単独で`UPDATE`処理をしている箇所がないか？

を確認し、問題があれば修正します。

:::message
DMS で Aurora MySQL v1 → v3 の移行をする場合は、 **エンドポイントの設定でタイムゾーンを指定しないようにします。**

- https://zenn.dev/hmatsu47/articles/mysql-dms-timezone

**2022/08/16 追記：**
`mediumblob`・`longblob`型の列と`ON UPDATE CURRENT_TIMESTAMP`付きの`timestamp`・`datetime`型の列を含むテーブルがある場合も、注意が必要です。

- https://zenn.dev/hmatsu47/articles/mysql-dms-cdc-timestamp-mismatch

:::

---

**2022/10/28 追記：**

実際の移行作業が終了したのでまとめました。

https://qiita.com/hmatsu47/items/ef48b8673f4775bef4a6
https://zenn.dev/hmatsu47/books/aurora-mysql-do-book
