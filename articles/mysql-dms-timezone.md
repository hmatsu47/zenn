---
title: "小ネタ／AWS DMS（CDC）で MySQL to MySQL 移行時のタイムゾーン指定"
emoji: "⌚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["mysql", "移行", "aws", "dms"]
published: false
---

AWS の DMS（CDC）でソース・ターゲットの両方が MySQL（RDS / Aurora MySQL）の場合、タイムゾーンの指定に注意が必要です。

## 前提

- DMS 3.4.7 を使用
- ソース・ターゲット各 MySQL サーバのタイムゾーン（`time_zone`）が正しく設定されている

元の設定がずれている（例：サーバの設定が`UTC`のまま`Asia/Tokyo`の日時値をタイムゾーンを無視して保存している）場合は違う状況になります。

## ポイント

- AWS DMS（Data Migration Service）の CDC（Change Data Capture）で MySQL（RDS / Aurora MySQL を含む）から MySQL（同）にデータをレプリケーションで移行するときは、 **ソース・ターゲットともエンドポイントのタイムゾーンを設定しない**

## 理由

MySQL では、内部的に

- `TIMESTAMP`型の日時は`1970-01-01 00:00:01.000000`以降の`UTC`日時
- `DATETIME`型の日時はタイムゾーンを持たない日時

を保持します。

一方、DMS ではどちらもデフォルトで DMS データ型`DATETIME`にマッピングされます。

この状況でソース側エンドポイントのタイムゾーンとして`UTC`以外、例えば`Asia/Tokyo`を選んで DB に接続したときに、DMS が **`TIMESTAMP`型の値を`UTC`ではなくローカルタイムゾーンの日時値として処理してしまう** ようです。つまり、ソース側を`UTC`以外にしてしまうと`TIMESTAMP`型の値がずれます。また、ソース側を`UTC`にしたとしてもターゲット側を別のタイムゾーンにすると日時の変換が掛かってしまうので値がずれます。

`DATETIME`型の値はタイムゾーンを持たないので、ソース側とターゲット側のエンドポイントのタイムゾーンが一致していれば日時の変換がかかることなくそのままデータが移行されます。

結果として、`TIMESTAMP`型も`DATETIME`型もタイムゾーンがずれないようにするには、ソース・ターゲットのエンドポイントのタイムゾーンを`UTC`（デフォルトのまま）にしておくのが良いことになります。

## 別の方法

`TIMESTAMP`型の列を DMS の文字列型にマッピングすれば、ソース・ターゲットのエンドポイントのタイムゾーンを`UTC`以外（`Asia/Tokyo`など）にした場合でも正しく移行できるようです。

ただ、DMS の`STRING`型を使うには全体の桁数（文字数）の指定（型の後ろにカッコで表記）が必要ですが（指定しないとエラーになります）、`TIMESTAMP`型における桁数指定は「秒未満の部分の桁数」となり意味が違うので、`STRING`型ではなく`CLOB`型を指定するのが良さそうです。
