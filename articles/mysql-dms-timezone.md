---
title: "小ネタ／AWS DMS（CDC）で MySQL to MySQL 移行時のタイムゾーン指定"
emoji: "⌚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["mysql", "移行", "aws", "dms"]
published: false
---

AWS の DMS（CDC）でソース・ターゲットの両方が MySQL（RDS / Aurora MySQL）の場合、タイムゾーンの指定に注意が必要です。

## 前提

- DMS 3.4.7 を使用
- ソース・ターゲット各 MySQL サーバのタイムゾーン（`time_zone`）が正しく設定されている

元の設定がずれている（例：サーバの`time_zone`設定が`UTC`のまま、タイムゾーンを無視して`Asia/Tokyo`の日時値を保存している）場合は違う状況になります。

## ポイント

- AWS DMS（Data Migration Service）の CDC（Change Data Capture）で MySQL（RDS / Aurora MySQL を含む）から MySQL（同）にデータをレプリケーションで移行するときは、 **ソースエンドポイントのタイムゾーンを設定しない**

## 理由

MySQL では、内部的に

- `TIMESTAMP`型の日時は`1970-01-01 00:00:01.000000`以降の`UTC`日時
- `DATETIME`型の日時はタイムゾーンを持たない日時

を保持します。

一方、DMS ではどちらもデフォルトで DMS データ型`DATETIME`にマッピングされます。

:::message
日時リテラルなどでタイムゾーンを指定した場合、接続タイムゾーンとの差分を調整した値が`DATETIME`型の列値となります。
例えば、接続タイムゾーンが`+09:00`（`Asia/Tokyo`）のときに`2020-07-19 18:00:00+00:00`を指定して`DATETIME`型の列に保存した場合、列値は`2020-07-20 03:00:00`となります。
:::

この状況でソースエンドポイントのタイムゾーンとして`UTC`以外、例えば`Asia/Tokyo`を選んで DB に接続したときに、DMS が **`TIMESTAMP`型の値を`UTC`ではなくローカルタイムゾーンの日時値として処理してしまう** ようです。つまり、ソース側を`UTC`以外にしてしまうと`TIMESTAMP`型の値がずれます。

`DATETIME`型の値はタイムゾーンを持たず、ソースエンドポイントのタイムゾーンに関わらずそのままデータが移行されます。

結果として、`TIMESTAMP`型も`DATETIME`型もタイムゾーンがずれないようにするには、ソースエンドポイントのタイムゾーンを`UTC`（デフォルトのまま）にしておくのが良いことになります。

ターゲットエンドポイントについては、デフォルト（`UTC`）のままでも`Asia/Tokyo`などを指定しても問題なくデータが移行されるようですが、特に理由がなければデフォルトのままにしておくのが良いでしょう。

## 別の方法

`TIMESTAMP`型の列を DMS の文字列型にマッピングすれば、ソースタイムゾーンを`UTC`以外（`Asia/Tokyo`など）にした場合でも正しく移行できるようです。

ただ、DMS の`STRING`型を使うには全体の桁数（文字数）の指定（型の後ろにカッコで表記）が必要ですが（指定しないとエラーになります）、`TIMESTAMP`型における桁数指定は「秒未満の部分の桁数」となり意味が違うので、`STRING`型ではなく`CLOB`型を指定するのが良さそうです。
