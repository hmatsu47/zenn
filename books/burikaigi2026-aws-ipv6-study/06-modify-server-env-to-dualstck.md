---
title: "サーバー環境を IPv6 対応にする"
---

さてようやく本題です。

サーバー環境を IPv6 対応にして、外部のユーザーが IPv4・IPv6 のどちらでアクセスしても応答可能にするには、以下の作業が必要です。

- VPC に IPv6 CIDR ブロックを追加（割り当て）
- パブリックサブネット（2 個）に IPv6 CIDR ブロック（VPC に割り当てた範囲の一部）を追加（割り当て）
- デュアルスタック ALB 用のセキュリティグループを作成（※）
- ALB をデュアルスタック化
- パブリックサブネットのルートテーブルに IPv6 のデフォルトルートを追加

（※）既存セキュリティグループを編集する形でもうまく行きそうな気がしますが、試したときは ALB をデュアルスタック化する設定に進めなかったので、念のため新規作成して回避しました。

この段階の作業が完了すると、図のとおりの構成になります。

![](/images/burikaigi2026-aws-ipv6-study/IPv6-02-server-ds.drawio.png)

作業対象となるサーバー部分を拡大すると以下のとおりです。

![](/images/burikaigi2026-aws-ipv6-study/IPv6-02.png)

## AWS 環境上での作業

### VPC に IPv6 CIDR ブロックを追加

- サーバー用 VPC の画面 → **「アクション」** → **「CIDR の編集」** から

![](/images/burikaigi2026-aws-ipv6-study/004001-add-ipv6-cidr-1.png)

- **「新しい IPv6 CIDR を追加」** をクリック
- 「Amazon 提供の IPv6 CIDR ブロック」を選択
- **「CIDR を選択」** をクリック

### パブリックサブネットに IPv6 CIDR ブロックの一部を割り当て

- サーバー用 VPC のパブリックサブネット（AZ-a）画面 → **「アクション」** → **「IPv6 CIDR の編集」** から

- **「IPv6 CIDR を追加」** をクリック

![](/images/burikaigi2026-aws-ipv6-study/004002-add-ipv6-cidr-2.png)

- サブネットの CIDR ブロック : VPC の CIDR ブロックの先頭`/64`（プレフィクスの最後が「`00`」）を選択
  - 下向き「>」を 2 回クリック
- **「保存」** をクリック

AZ-b 側も同様に割り当てます。

- サーバー用 VPC のパブリックサブネット（AZ-b）画面 → **「アクション」** → **「IPv6 CIDR の編集」** から

- **「IPv6 CIDR を追加」** をクリック

![](/images/burikaigi2026-aws-ipv6-study/004003-add-ipv6-cidr-3.png)

- サブネットの CIDR ブロック : VPC の CIDR ブロックの 2 番目の`/64`（プレフィクスの最後が「`01`」）を選択
  - 下向き「>」を 2 回クリック後、右向き「>」を 1 回クリック
- **「保存」** をクリック

### デュアルスタック ALB 用のセキュリティグループを作成

- **「VPC」** メニュー → セキュリティグループから
- **「セキュリティグループを作成」** をクリック

![](/images/burikaigi2026-aws-ipv6-study/005001-create-dualstack-alb-sg.png)

- セキュリティグループ名 : `dualstack-alb`
- 説明 : `dualstack-alb`
- VPC : サーバー用 VPC
- **「セキュリティグループを作成」** をクリック

### ALB に新しいセキュリティグループを割り当て

- ALB の画面 → **「アクション」** → **「セキュリティグループの編集」** から

![](/images/burikaigi2026-aws-ipv6-study/005002-modify-alb-sg.png)

- セキュリティグループ : 「dualstack-alb」のみ選択
- **「セキュリティグループを作成」** をクリック

### ALB をデュアルスタック化

- ALB の画面 → **「アクション」** → **「IP アドレスタイプの編集」** から

![](/images/burikaigi2026-aws-ipv6-study/005003-modify-alb-to-dualstack.png)

- ロードバランサーの IP アドレスタイプ : Dualstack
- **「変更内容の保存」** をクリック

### パブリックサブネットのルートテーブルに IPv6 のデフォルトルートを追加

- サーバー用 VPC のパブリックルートテーブル画面 → **「ルートを編集」** から

![](/images/burikaigi2026-aws-ipv6-study/005004-modify-public-route.png)

- **「ルートを追加」** で以下のルートを追加
  - 送信先 : `::/0`
  - ターゲット : インターネットゲートウェイ（既存の`igw-XXXXXXXX`）
- **「変更を保存」** をクリック

### （オプション）Route 53 に AAAA レコードのエイリアスを登録

セッションでは実施しませんが、独自ドメインで使う場合は Route 53 のホストゾーンに AAAA レコードのエイリアスとして ALB を追加します。

以上でサーバー環境のデュアルスタック化が完了しました。

## 作業内容に関する補足説明

### ALB のデュアルスタック化？

ここまで IPv4・IPv6 について触れてきましたが、IPv6 は IPv4 とは互換性がなく、あるホストが IPv6 をサポートしたからといって IPv4 しかサポートしていないホストとは直接通信を行うことができません。

つまり、あるホストから IPv4 と IPv6 の両方のホストと直接通信しようとする場合は、IPv4 と IPv6 の両方が動作する状態に設定する必要があります。

このような状態や仕組みのことを一般に「デュアルスタック」と呼びます。

ALB は外部のクライアントからの HTTP(S) アクセスを VPC 内の Web サーバーに中継する役割を担いますが、ALB を「IPv4 と IPv6 の両方が動作する」デュアルスタック設定にしておくと、中継先の Web サーバーが IPv4 または IPv6 の片方しかサポートしていなくても、IPv4・IPv6 の両方のクライアントからのアクセスを処理可能になります。

### IPv6 アドレスの構成

アドレス全体で 128 ビットあります。16 ビットごとに「`:`」で区切って 4 ビットごとに十六進表記します（例：`2001:0db8:0000:0000:0000:0002:0000:0001`）。

なお原則として、前半 64 ビットをサブネットプレフィックス、後半 64 ビットをインターフェース識別子（IID）と呼びます。

ただしこのままだと表記が長くなりすぎるので、省略形の表記ルールがあります。

- 16 ビット区切りのフィールドの先頭で連続する`0`は省略可
- 複数の 16 ビットフィールドで`0`が連続する場合は「`::`」で省略可

などです（先ほどの例は`2001:db8::2:0:1`または`2001:db8:0:0:0:2::1`のように省略表記が可能）。

### IPv6 グローバルユニークアドレス（GUA）について

IPv6 は IPv4 と同じく用途別に複数種のアドレスがあります。IPv4 におけるグローバルアドレスと同様にインターネットに直接接続可能なアドレスはグローバルユニークアドレス（GUA）と呼びます。

IPv6 にも IPv4 におけるプライベートアドレスと同様の使い方が可能なアドレス（ULA：ユニークローカルユニキャストアドレス）がありますが、IPv6 では ULA と GUA の間で NAT を行うことは非推奨です（AWS の NAT ゲートウェイでもサポートされていません）ので、通常はサブネットのパブリック・プライベートに関係なく、インターネットへのアクセスが必要であれば GUA を割り当てるのが一般的です。

:::message
クライアント環境で GUA を使う構成、およびインターネットアクセスを行わないサブネットで ULA を使う構成については、後のチャプターで説明します。
:::

### アプリケーション側で必要な対応

ここまでは AWS リソースの変更作業に焦点をあててきましたが、アプリケーション側でも場合によっては対応が必要です。

例えば IP アドレスを文字列として扱う場合、最大文字数が IPv4 の場合サブネット長なしで 15 文字、サブネット長付きで 18 文字なのに対し、それぞれ 39 文字・42 文字に増えます。

データベースでの格納形式も（PostgreSQL の`cidr`型や`inet`型のような IP アドレス専用データ型を使っていなければ）変更する必要があるかもしれませんし、単純に画面表示だけのことを考えても「表示が崩れないか」などの考慮事項があります。

そして、IP アドレスを文字列として扱うケースでアドレス同士の比較が必要な場合、IPv4 アドレスと比べて IPv6 アドレスの表記が柔軟であり 1 つのアドレスの表記方法が多数存在しうるため、これを一意に表記することで比較しやすくする必要があります。

#### IPv6 アドレスを一意に表記するには？

[RFC 5952](https://datatracker.ietf.org/doc/html/rfc5952) で一意に表記する方法が示されています。

- 「`::`」での短縮時には可能な限り短く表記する
  - 例：`2001:db8::0:2:1`のような表記をしない
- 16 ビットフィールドの`0`が 1 つだけの場合は「`::`」で短縮しない
  - 例：`2001:db8:0:1:1:1:1:1`を`2001:db8::1:1:1:1:1`と表記しない
- 最も短縮できる箇所で「`::`」を使う
- 同じ長さの「16 ビットの `0`」が連続する箇所がある場合は、最初（より上位のビット・最も左側）の箇所で「`::`」を使う
- アルファベットは lower case で表記する
- IPv4 アドレスが埋め込まれた特殊な IPv6 アドレスは、先頭部分の`0`の連続を「`::`」で短縮する
  - 例：`::ffff:192.0.2.1`
- ポート番号との表記で区切りに「`:`」を使うときは IPv6 アドレス部分を「`[]`」で括る（推奨）
  - 例：`[2001:db8::1]:80`

## このチャプターのまとめ

- サーバー環境を IPv6 対応にするには、境界で中継する箇所をデュアルスタック化する
  - Web の場合は ALB をデュアルスタック化する
  - ALB のパブリック側のサブネットに IPv6 アドレス（GUA）を割り当てる
- Web サーバー自体には IPv6 アドレスを割り当てなくても良いが、アプリケーション側で正しく IPv6 アドレスを扱えるようにしておく
- セキュリティグループやルートテーブルも忘れずに IPv6 の通信を流せるようにしておく
  - この構成では扱っていないが、NACL を使っている場合は NACL も
